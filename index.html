<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>539 精準分析 V42.2-L Optimized</title>
<style>
:root{
 --bg:#000;--panel:#1c1c1e;--primary:#ffd60a;--border:#38383a;
 --text:#fff;--sub:#8e8e93;--hit:#ff375f;--accent:#0a84ff;--success:#32d74b;
}
body{font-family:'PingFang TC',sans-serif;background:var(--bg);color:var(--text);margin:0;padding:10px;font-size:13px}
.container{display:flex;flex-direction:column;gap:12px}
.panel{background:var(--panel);border-radius:12px;padding:12px;border:1px solid var(--border)}
.panel-header{color:var(--primary);font-weight:bold;margin-bottom:10px;border-left:3px solid var(--primary);padding-left:8px;font-size:14px}
.bt-row{border-bottom:1px solid var(--border);padding:10px 0;display:flex;flex-direction:column;gap:6px}
.bt-meta{display:flex;justify-content:space-between;color:var(--sub);font-size:11px}
.num-group{display:flex;gap:4px;align-items:center}
.num-label{font-size:10px;color:var(--sub);width:30px;flex-shrink:0}
.n-box{width:22px;height:22px;display:flex;align-items:center;justify-content:center;border-radius:4px;background:#2c2c2e;font-size:11px;font-weight:bold}
.n-box.hit{background:var(--primary);color:#000;box-shadow:0 0 5px var(--primary)}
.star-tag{background:var(--success);color:#000;padding:2px 8px;border-radius:4px;font-weight:900}
.matrix-scroll{overflow-x:auto;border:1px solid var(--border);border-radius:8px}
.m-table{border-collapse:collapse;white-space:nowrap}
.m-table td,.m-table th{border:1px solid #333;width:18px;height:18px;text-align:center;font-size:9px}
.m-head{background:#2c2c2e;color:var(--primary);position:sticky;top:0}
.m-date{background:#2c2c2e;color:var(--sub);position:sticky;left:0;width:50px;z-index:5}
.m-ball{background:var(--hit);border-radius:50%;width:12px;height:12px;display:inline-block}
#logBox{background:#000;color:var(--success);padding:10px;height:80px;overflow-y:auto;font-family:monospace;font-size:11px;border:1px solid var(--border)}
.ball-row{display:flex;flex-wrap:wrap;gap:6px}
.ball{width:38px;height:38px;display:flex;align-items:center;justify-content:center;background:#2c2c2e;border-radius:50%;font-weight:bold;border:2px solid var(--accent);color:var(--accent);font-size:16px}
</style>
</head>
<body>

<div class="container">

<div class="panel">
 <div class="panel-header">P1: 數據注入</div>
 <input type="file" id="csvFile" accept=".csv">
</div>

<div class="panel">
 <div class="panel-header">P2: 深度回測（自動學習 V42.2-L Optimized）</div>
 <div id="btBody"></div>
</div>

<div class="panel">
 <div class="panel-header">P3: 下期結構預測 (8 碼)</div>
 <div id="nextPred" class="ball-row"></div>
</div>

<div class="panel">
 <div class="panel-header">P4: 分布矩陣</div>
 <div class="matrix-scroll" id="matrixCont"></div>
</div>

<div class="panel"><div id="logBox">等待 CSV 匯入...</div></div>

</div>

<script>
let rawData=[];
const log=m=>{logBox.innerHTML+=`> ${m}<br>`;logBox.scrollTop=logBox.scrollHeight}
const pad=n=>n.toString().padStart(2,'0')
const formatDate=s=>{let p=s.split(/[-/]/);return p.length>=3?`${p[1]}/${p[2]}`:s}

// ====== 自動學習狀態 ======
let learn={
 gapW:6,
 tailW:5,
 neighbor:true,
 zoneBias:[1,1,1]
}

// ====== 優化預測函數 ======
function predictV42L(hist){
 if(hist.length<20) return [1,2,3,4,5,6,7,8];

 let stats=Array.from({length:39},(_,i)=>({n:i+1,score:0}));
 let last=hist.at(-1).nums;

 // gap 分數
 for(let i=1;i<=39;i++){
  let gap=0;
  for(let k=hist.length-1;k>=0;k--){
   if(!hist[k].nums.includes(i)) gap++; else break;
  }
  stats[i-1].score += gap<=12 ? gap*learn.gapW : Math.max(0,38-gap);
 }

 // tail 分數
 let tail=Array(10).fill(0);
 hist.slice(-15).forEach(d=>d.nums.forEach(n=>tail[n%10]++));
 stats.forEach(s=>s.score += tail[s.n%10]*learn.tailW);

 // 鄰號加分
 if(learn.neighbor){
  last.forEach(n=>{
   if(n>1) stats[n-2].score+=20;
   if(n<39) stats[n].score+=20;
   stats[n-1].score+=15;
  })
 }

 // zones 選碼
 let zones=[[],[],[]];
 stats.forEach(s=>{
  zones[Math.floor((s.n-1)/13)].push(s);
 });
 let pool=[];
 zones.forEach((z,i)=>{
  z.sort((a,b)=>b.score-a.score || a.n-b.n);
  pool.push(...z.slice(0,3+Math.max(0,learn.zoneBias[i])));
 });
 return pool.sort((a,b)=>b.score-a.score).slice(0,10).map(x=>x.n).sort((a,b)=>a-b).slice(0,8);
}

// ====== CSV 匯入 ======
csvFile.addEventListener('change',e=>{
 let r=new FileReader();
 r.onload=()=>{
  rawData=r.result.replace(/\r/g,'').trim().split('\n').slice(1).map(l=>{
   let c=l.split(',');
   return{date:c[0],nums:c.slice(1,6).map(Number).sort((a,b)=>a-b)};
  });
  logBox.innerHTML='';
  run();
 }
 r.readAsText(e.target.files[0])
})

// ====== 回測與自動學習 ======
function run(){
 let html='',hitsArr=[];
 let sliceStart=Math.max(0,rawData.length-40); // 保證至少40期歷史
 rawData.slice(-10).forEach((row,idx)=>{
  let hist = rawData.slice(sliceStart, rawData.length-10+idx+1);
  let pred=predictV42L(hist);
  let hits=row.nums.filter(n=>pred.includes(n)).length;
  hitsArr.push(hits);

  // 自動學習更新權重
  let reward=hits>=3?1:(hits==2?0.3:-0.5);
  learn.gapW   *= 1+reward*0.1;
  learn.tailW  *= 1+reward*0.08;
  learn.zoneBias.forEach((v,i)=>learn.zoneBias[i] += reward>0?1:0);
  learn.neighbor = hits>=3;

  html+=`<div class="bt-row">
    <div class="bt-meta"><span>${formatDate(row.date)}</span>
    <span class="star-tag">${hits} ★</span></div>
    <div class="num-group"><span class="num-label">開獎</span>
      ${row.nums.map(n=>`<div class="n-box ${pred.includes(n)?'hit':''}">${pad(n)}</div>`).join('')}
    </div>
    <div class="num-group"><span class="num-label">預測</span>
      ${pred.map(n=>`<div class="n-box">${pad(n)}</div>`).join('')}
    </div>
  </div>`;
 });

 btBody.innerHTML=html;

 // 下期預測
 let next=predictV42L(rawData);
 nextPred.innerHTML=next.map(n=>`<div class="ball">${pad(n)}</div>`).join('');

 // 分布矩陣
 let m=`<table class="m-table"><thead><tr><th class="m-date">日</th>`;
 for(let i=1;i<=39;i++) m+=`<th class="m-head">${pad(i)}</th>`;
 m+=`</tr></thead><tbody>`;
 rawData.slice(-15).forEach(r=>{
  m+=`<tr><td class="m-date">${formatDate(r.date)}</td>`;
  for(let i=1;i<=39;i++) m+=`<td>${r.nums.includes(i)?'<span class="m-ball"></span>':''}</td>`;
  m+='</tr>';
 });
 matrixCont.innerHTML=m+'</tbody></table>';

 // 平均命中
 let avg=(hitsArr.reduce((a,b)=>a+b,0)/hitsArr.length).toFixed(2);
 log(`近十期平均命中 ${avg} 碼 | 權重 gap=${learn.gapW.toFixed(2)}, tail=${learn.tailW.toFixed(2)}, neighbor=${learn.neighbor}`);
}
</script>
</body>
</html>
