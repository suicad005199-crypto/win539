<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root { --ios-red: #FF3B30; --ios-yellow: #FFCC00; --ios-blue: #007AFF; --ios-bg: #1c1c1e; }
        body { margin: 0; background: var(--ios-bg); color: white; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; touch-action: manipulation; }
        
        /* ç‹€æ…‹åˆ— */
        #status-bar { width: 90vw; max-width: 400px; padding: 20px 0; display: flex; align-items: flex-start; gap: 12px; }
        .avatar { width: 50px; height: 50px; background: #3a3a3c; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 2rem; border: 1px solid #555; }
        .info-panel { flex: 1; }
        .lv-txt { font-weight: bold; font-size: 14px; margin-bottom: 4px; display: block; }
        
        /* é€²åº¦æ¢ç³»çµ± */
        .bar-container { width: 100%; height: 10px; background: #333; border-radius: 5px; overflow: hidden; margin-bottom: 6px; position: relative; border: 1px solid #444; }
        .bar-fill { height: 100%; transition: width 0.2s; }
        .hp-fill { background: var(--ios-red); }
        .exp-fill { background: var(--ios-yellow); }
        .bar-label { position: absolute; font-size: 8px; top: 50%; left: 4px; transform: translateY(-50%); font-weight: bold; text-shadow: 1px 1px 2px black; }

        /* 8x8 ç¶²æ ¼ */
        .grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; width: 95vw; max-width: 400px; background: #2c2c2e; padding: 6px; border-radius: 12px; position: relative; }
        .cell { aspect-ratio: 1; background: #444; border-radius: 4px; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; position: relative; overflow: hidden; }
        .entity { font-size: 1.4rem; margin-bottom: 4px; flex-grow: 1; display: flex; align-items: center; }
        .player { background: var(--ios-blue) !important; z-index: 10; box-shadow: 0 0 10px var(--ios-blue); transition: transform 0.1s; }
        
        /* æ€ªç‰©æ–¹æ ¼è¡€æ¢ */
        .mob-bar-bg { width: 85%; height: 4px; background: #000; margin-bottom: 4px; border-radius: 2px; overflow: hidden; }
        .mob-bar-fill { height: 100%; background: var(--ios-red); width: 100%; }
        
        /* ç¢°æ’å‹•ç•« */
        @keyframes bump {
            0% { transform: scale(1); }
            50% { transform: scale(1.2) translate(0, -2px); }
            100% { transform: scale(1); }
        }
        .bumping { animation: bump 0.15s infinite; }
        
        #room-tag { margin-top: 15px; font-size: 12px; color: #888; letter-spacing: 1px; }
    </style>
</head>
<body>

<div id="status-bar">
    <div class="avatar">ğŸ‘¤</div>
    <div class="info-panel">
        <span class="lv-txt">LV <span id="pl-lv">1</span></span>
        <div class="bar-container">
            <div id="hp-bar" class="bar-fill hp-fill" style="width: 100%;"></div>
            <span class="bar-label">HP</span>
        </div>
        <div class="bar-container">
            <div id="exp-bar" class="bar-fill exp-fill" style="width: 0%;"></div>
            <span class="bar-label">EXP</span>
        </div>
        <div style="font-size: 11px; color: var(--ios-yellow); font-weight: bold;">ATK: <span id="pl-atk">10</span></div>
    </div>
</div>

<div class="grid" id="grid"></div>
<div id="room-tag">AREA <span id="room-num">1</span></div>

<script>
    let state = { 
        hp: 100, maxHp: 100, exp: 0, nextExp: 100, 
        atk: 10, lv: 1, room: 1, playerPos: 0, isActing: false 
    };
    let map = [];

    function initRoom() {
        map = [];
        let pool = ['P', 'B', ...Array(6).fill('H'), ...Array(6).fill('S'), ...Array(50).fill('M')];
        pool.sort(() => Math.random() - 0.5);
        
        pool.forEach((type, i) => {
            let obj = { type, hp: 0, maxHp: 0 };
            if (type === 'M') { 
                obj.maxHp = obj.hp = 20 + (state.room * 10); 
            } else if (type === 'B') { 
                obj.maxHp = obj.hp = 150 + (state.room * 50); 
            } else if (type === 'P') { 
                state.playerPos = i; 
            }
            map.push(obj);
        });
        render();
    }

    function render() {
        const gridEl = document.getElementById('grid');
        gridEl.innerHTML = '';
        map.forEach((cell, i) => {
            const div = document.createElement('div');
            div.className = `cell ${i === state.playerPos ? 'player' : ''}`;
            
            let content = '';
            if (i === state.playerPos) {
                content = '<div class="entity">ğŸ‘¤</div>';
            } else if (cell.type === 'M' || cell.type === 'B') {
                const icon = cell.type === 'M' ? 'ğŸ‘¾' : 'ğŸ‘¹';
                const hpPercent = (cell.hp / cell.maxHp) * 100;
                content = `
                    <div class="entity">${icon}</div>
                    <div class="mob-bar-bg"><div class="mob-bar-fill" style="width:${hpPercent}%"></div></div>
                `;
            } else if (cell.type === 'H') content = '<div class="entity">â¤ï¸</div>';
            else if (cell.type === 'S') content = '<div class="entity">âš¡</div>';
            
            div.innerHTML = content;
            div.onclick = () => handleAction(i);
            gridEl.appendChild(div);
        });
        updateUI();
    }

    async function handleAction(target) {
        if (state.isActing || getDist(state.playerPos, target) !== 1) return;
        state.isActing = true;
        
        const targetObj = map[target];
        const playerDiv = document.querySelectorAll('.cell')[state.playerPos];

        if (targetObj.type === 'M' || targetObj.type === 'B') {
            // é€²å…¥æˆ°é¬¥å¾ªç’°
            playerDiv.classList.add('bumping');
            
            while(targetObj.hp > 0 && state.hp > 0) {
                targetObj.hp -= state.atk;
                state.hp -= Math.max(1, Math.floor(targetObj.hp / 10)); // åæ“Šå‚·å®³
                
                render(); // æ›´æ–°æ€ªç‰©è¡€æ¢èˆ‡ç©å®¶ç‹€æ…‹
                updateUI();
                
                if (state.hp <= 0) break;
                await new Promise(r => setTimeout(r, 200)); // ç¢°æ’é–“éš”
            }
            
            playerDiv.classList.remove('bumping');

            if (state.hp > 0) {
                state.exp += (targetObj.type === 'B' ? 100 : 40);
                if (state.exp >= state.nextExp) levelUp();
                if (targetObj.type === 'B') {
                    alert("å€åŸŸæ¸…ç†å®Œæˆï¼Œå‰å¾€ä¸‹ä¸€å±¤ã€‚");
                    state.room++;
                    initRoom();
                } else {
                    movePlayer(target);
                }
            }
        } else if (targetObj.type === 'H') {
            state.hp = Math.min(state.maxHp, state.hp + 30);
            movePlayer(target);
        } else if (targetObj.type === 'S') {
            state.atk += 3;
            movePlayer(target);
        } else {
            movePlayer(target);
        }

        if (state.hp <= 0) {
            alert("ä½ å€’ä¸‹äº†ã€‚å†’éšªçµæŸã€‚");
            location.reload();
        }
        
        state.isActing = false;
        render();
    }

    function levelUp() {
        state.lv++;
        state.exp = 0;
        state.nextExp += 50;
        state.atk += 5;
        state.maxHp += 20;
    }

    function movePlayer(target) {
        map[state.playerPos] = { type: 'E' };
        state.playerPos = target;
        map[state.playerPos] = { type: 'P' };
    }

    function getDist(p1, p2) {
        const x1 = p1 % 8, y1 = Math.floor(p1 / 8);
        const x2 = p2 % 8, y2 = Math.floor(p2 / 8);
        return Math.abs(x1 - x2) + Math.abs(y1 - y2);
    }

    function updateUI() {
        document.getElementById('hp-bar').style.width = `${Math.max(0, (state.hp / state.maxHp) * 100)}%`;
        document.getElementById('exp-bar').style.width = `${(state.exp / state.nextExp) * 100}%`;
        document.getElementById('pl-lv').innerText = state.lv;
        document.getElementById('pl-atk').innerText = state.atk;
        document.getElementById('room-num').innerText = state.room;
    }

    initRoom();
</script>
</body>
</html>
