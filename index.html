<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root { --ios-red: #FF3B30; --ios-yellow: #FFCC00; --ios-blue: #007AFF; --ios-bg: #1c1c1e; }
        body { margin: 0; background: #000; color: white; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow: hidden; }
        
        /* æ•…äº‹èˆ‡é–‹å§‹ä»‹é¢ */
        #start-screen {
            position: fixed; inset: 0; background: #000; z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; text-align: center; transition: opacity 0.8s;
        }
        .story-text { font-size: 1.1rem; line-height: 1.8; color: #ccc; margin-bottom: 40px; max-width: 300px; }
        .start-btn { 
            background: none; border: 2px solid var(--ios-blue); color: var(--ios-blue);
            padding: 12px 40px; border-radius: 30px; font-size: 1.2rem; font-weight: bold;
            box-shadow: 0 0 15px rgba(0,122,255,0.3); cursor: pointer;
        }

        /* éŠæˆ²ä»‹é¢ (åˆå§‹éš±è—) */
        #game-ui { opacity: 0; transition: opacity 1s; display: flex; flex-direction: column; align-items: center; }
        
        #status-bar { width: 90vw; max-width: 400px; padding: 20px 0; display: flex; align-items: center; gap: 12px; }
        .avatar { width: 50px; height: 50px; background: #3a3a3c; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; }
        .bar-container { width: 100%; height: 8px; background: #333; border-radius: 4px; overflow: hidden; margin-top: 4px; }
        .bar-fill { height: 100%; transition: width 0.3s; }
        .hp-fill { background: var(--ios-red); }
        .exp-fill { background: var(--ios-yellow); }

        /* ç¶²æ ¼ç³»çµ± */
        .grid-container { position: relative; padding: 6px; background: #2c2c2e; border-radius: 12px; }
        .grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; width: 90vw; max-width: 380px; }
        .cell { aspect-ratio: 1; background: #444; border-radius: 4px; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; position: relative; }
        
        /* ç©å®¶å¯¦é«” */
        #player-token {
            position: absolute; width: calc((90vw - 12px - 28px) / 8); height: calc((90vw - 12px - 28px) / 8);
            max-width: 43px; max-height: 43px; background: var(--ios-blue); border-radius: 4px; z-index: 100;
            display: flex; align-items: center; justify-content: center; font-size: 1.3rem;
            transition: transform 0.2s cubic-bezier(0.1, 0.9, 0.2, 1); pointer-events: none;
        }

        /* æ€ªç‰©è¡€æ¢ */
        .mob-bar-bg { width: 80%; height: 3px; background: #000; margin-bottom: 3px; border-radius: 2px; }
        .mob-bar-fill { height: 100%; background: var(--ios-red); }

        /* å‹•ç•«æ•ˆæœ */
        .room-title { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 3rem; font-weight: 900; pointer-events: none; opacity: 0; z-index: 1500;
        }
        .flash-text { animation: textAnim 1.5s forwards; }
        @keyframes textAnim { 
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
        }
        .dmg-popup { position: absolute; color: var(--ios-red); font-weight: bold; animation: floatUp 0.6s forwards; z-index: 200; }
        @keyframes floatUp { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-30px); } }
    </style>
</head>
<body>

    <div id="start-screen">
        <div class="story-text" id="story-box">
            å¤è€çš„é˜è²æ•²éŸ¿ï¼Œ<br>
            æœ€å¾Œçš„å…‰èŠ’åœ¨è£‚è°·ä¸­ç†„æ»…ã€‚<br>
            ä½ æ¡ç·Šæ®˜ç ´çš„åŠæŸ„ï¼Œ<br>
            éš»èº«è¸å…¥é€™åº§æ°¸å¤œçš„åœ°ç‰¢...
        </div>
        <button class="start-btn" onclick="startGame()">ENTER DUNGEON</button>
    </div>

    <div id="game-ui">
        <div id="status-bar">
            <div class="avatar">ğŸ‘¤</div>
            <div class="info-panel" style="flex:1">
                <div style="font-size:12px">LV <span id="pl-lv">1</span> | ATK: <span id="pl-atk">15</span></div>
                <div class="bar-container"><div id="hp-bar" class="bar-fill hp-fill" style="width:100%"></div></div>
                <div class="bar-container"><div id="exp-bar" class="bar-fill exp-fill" style="width:0%"></div></div>
            </div>
        </div>

        <div class="grid-container" id="map-wrap">
            <div id="player-token">ğŸ‘¤</div>
            <div class="grid" id="grid"></div>
        </div>
        <div style="margin-top:15px; color:#666; font-size:12px">AREA <span id="room-num">1</span></div>
    </div>

    <div id="room-title" class="room-title"></div>

<script>
    let state = { hp: 100, maxHp: 100, exp: 0, nextExp: 100, atk: 15, lv: 1, room: 1, playerPos: 0, isActing: false };
    let map = [];

    async function startGame() {
        document.getElementById('start-screen').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-ui').style.opacity = '1';
            initRoom(true);
        }, 800);
    }

    async function initRoom(showTitle = false) {
        if (showTitle) {
            const title = document.getElementById('room-title');
            title.innerText = `ROOM ${state.room}`;
            title.classList.add('flash-text');
            await new Promise(r => setTimeout(r, 1500));
            title.classList.remove('flash-text');
        }

        map = [];
        let pool = ['P', 'B', ...Array(5).fill('H'), ...Array(5).fill('S'), ...Array(52).fill('M')];
        pool.sort(() => Math.random() - 0.5);
        pool.forEach((type, i) => {
            let obj = { type, hp: 0, maxHp: 0 };
            if (type === 'M' || type === 'B') {
                obj.maxHp = obj.hp = (type === 'M' ? 30 : 250) + (state.room * 20);
            }
            if (type === 'P') state.playerPos = i;
            map.push(obj);
        });
        
        render();
        syncPlayerToken();
    }

    function render() {
        const gridEl = document.getElementById('grid');
        gridEl.innerHTML = '';
        map.forEach((cell, i) => {
            const div = document.createElement('div');
            div.className = 'cell';
            if (cell.type === 'M' || cell.type === 'B') {
                div.innerHTML = `<div style="flex:1;display:flex;align-items:center;font-size:1.4rem">${cell.type === 'M'?'ğŸ‘¾':'ğŸ‘¹'}</div>
                                 <div class="mob-bar-bg"><div class="mob-bar-fill" style="width:${(cell.hp/cell.maxHp)*100}%"></div></div>`;
            } else if (cell.type === 'H') div.innerHTML = '<div style="flex:1;display:flex;align-items:center">â¤ï¸</div>';
            else if (cell.type === 'S') div.innerHTML = '<div style="flex:1;display:flex;align-items:center">âš¡</div>';
            div.onclick = () => handleAction(i);
            gridEl.appendChild(div);
        });
        updateUI();
    }

    function syncPlayerToken() {
        const cells = document.querySelectorAll('.cell');
        if (!cells[state.playerPos]) return;
        const target = cells[state.playerPos];
        const token = document.getElementById('player-token');
        token.style.transform = `translate(${target.offsetLeft}px, ${target.offsetTop}px)`;
    }

    async function handleAction(target) {
        if (state.isActing || getDist(state.playerPos, target) !== 1) return;
        state.isActing = true;
        const targetObj = map[target];
        const token = document.getElementById('player-token');
        const targetCell = document.querySelectorAll('.cell')[target];

        if (targetObj.hp > 0) {
            while (targetObj.hp > 0 && state.hp > 0) {
                // ç©å®¶æ”»æ“Š
                token.style.transform = `translate(${targetCell.offsetLeft}px, ${targetCell.offsetTop}px) scale(1.1)`;
                targetObj.hp -= state.atk;
                showDmg(targetCell, state.atk);
                await new Promise(r => setTimeout(r, 150));
                render();

                if (targetObj.hp <= 0) break;

                // æ€ªç‰©åæ“Š
                token.style.transform = `translate(${token.offsetLeft}px, ${token.offsetTop}px)`;
                let dmg = Math.max(2, Math.floor(targetObj.hp/10));
                state.hp -= dmg;
                showDmg(token, dmg);
                updateUI();
                await new Promise(r => setTimeout(r, 150));
            }

            if (state.hp > 0) {
                state.exp += (targetObj.type === 'B' ? 100 : 40);
                if (state.exp >= state.nextExp) levelUp();
                if (targetObj.type === 'B') {
                    state.room++;
                    await initRoom(true);
                } else {
                    movePlayer(target);
                }
            }
        } else {
            if (targetObj.type === 'H') state.hp = Math.min(state.maxHp, state.hp+30);
            if (targetObj.type === 'S') state.atk += 3;
            movePlayer(target);
        }

        if (state.hp <= 0) { alert("ä½ å·²åŠ›ç«­ï¼Œå€’åœ¨é™°å½±ä¹‹ä¸­..."); location.reload(); }
        state.isActing = false;
        syncPlayerToken();
        render();
    }

    function showDmg(el, val) {
        const d = document.createElement('div');
        d.className = 'dmg-popup';
        d.innerText = `-${val}`;
        el.appendChild(d);
        setTimeout(() => d.remove(), 600);
    }

    function movePlayer(t) {
        map[state.playerPos] = { type: 'E' };
        state.playerPos = t;
        map[state.playerPos] = { type: 'P' };
    }

    function levelUp() {
        state.lv++; state.exp = 0; state.nextExp += 50; state.atk += 5; state.maxHp += 20;
    }

    function getDist(p1, p2) {
        return Math.abs(p1%8 - p2%8) + Math.abs(Math.floor(p1/8) - Math.floor(p2/8));
    }

    function updateUI() {
        document.getElementById('hp-bar').style.width = `${(state.hp/state.maxHp)*100}%`;
        document.getElementById('exp-bar').style.width = `${(state.exp/state.nextExp)*100}%`;
        document.getElementById('pl-lv').innerText = state.lv;
        document.getElementById('pl-atk').innerText = state.atk;
        document.getElementById('room-num').innerText = state.room;
    }

    window.onresize = syncPlayerToken;
</script>
</body>
</html>
