<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>539 RL-Engine V.43.5 - 強化學習版</title>
    <style>
        :root { --bg: #09090b; --panel: #18181b; --primary: #ffd60a; --border: #27272a; --text: #fafafa; --sub: #a1a1aa; --hit: #ef4444; --accent: #3b82f6; --success: #22c55e; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 12px; font-size: 13px; line-height: 1.5; }
        .container { display: flex; flex-direction: column; gap: 15px; }
        .panel { background: var(--panel); border-radius: 12px; padding: 15px; border: 1px solid var(--border); box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .panel-header { color: var(--primary); font-weight: 800; margin-bottom: 12px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.05em; display: flex; justify-content: space-between; align-items: center; }
        
        /* 訓練指標看板 */
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
        .stat-card { background: #000; padding: 10px; border-radius: 8px; border-left: 3px solid var(--accent); }
        .stat-label { font-size: 11px; color: var(--sub); text-transform: uppercase; }
        .stat-val { font-size: 16px; font-weight: 700; color: var(--text); }

        /* 權重監視器 */
        .weight-flex { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px; }
        .w-chip { background: #27272a; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-family: monospace; border: 1px solid var(--border); }
        .w-chip.active { border-color: var(--success); color: var(--success); }

        .bt-row { border-bottom: 1px solid var(--border); padding: 12px 0; display: flex; flex-direction: column; gap: 8px; }
        .n-box { width: 26px; height: 26px; display: flex; align-items: center; justify-content: center; border-radius: 6px; background: #27272a; font-size: 12px; font-weight: 600; transition: 0.3s; }
        .n-box.hit { background: var(--primary); color: #000; box-shadow: 0 0 12px rgba(255,214,10,0.4); border: none; }
        
        .log-box { background: #000; color: #22c55e; padding: 12px; height: 110px; overflow-y: auto; font-family: 'Fira Code', monospace; font-size: 11px; border: 1px solid var(--border); border-radius: 8px; }
        .ball { width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; background: radial-gradient(circle at 30% 30%, #3b82f6, #1d4ed8); border-radius: 50%; font-weight: 900; color: white; font-size: 18px; box-shadow: 0 5px 15px rgba(59,130,246,0.4); }
    </style>
</head>
<body>
<div class="container">
    <div class="panel">
        <div class="panel-header">系統核心 <span>RL-OPTIMIZER v43.5</span></div>
        <input type="file" id="csvFile" accept=".csv" style="color:var(--sub); font-size: 12px;">
    </div>
    
    <div class="panel">
        <div class="panel-header">自適應學習狀態 (Learning Status)</div>
        <div id="weightDisplay" class="weight-flex"></div>
        <div id="statsDisplay" class="stats-grid"></div>
    </div>

    <div class="panel">
        <div class="panel-header">強化學習回測 (RL Training Loop)</div>
        <div id="btBody"></div>
    </div>

    <div class="panel">
        <div class="panel-header">下期決策 (Global Optimal Prediction)</div>
        <div id="nextPred" style="display:flex; gap:8px; justify-content: center; padding: 10px 0;"></div>
    </div>

    <div class="panel">
        <div id="logBox" class="log-box">初始化引擎... 等待數據注入以啟動強化學習迴圈。</div>
    </div>
</div>

<script>
    // 初始超參數
    const HYPER = {
        lr: 0.08,        // 學習率 (梯度下降速度)
        targetHit: 2.2,  // 目標命中數
        resetThreshold: 5, // 連續低命中重置門檻
        lambda: 0.6      // 懲罰項系數 (穩定度優先)
    };

    let weights = { gap: 4.5, tail: 3.2, neighbor: 35.0, reentry: 22.0, hotCold: 15.0 };
    const LIMITS = { gap: [2, 8], tail: [1, 6], neighbor: [10, 55], reentry: [10, 45], hotCold: [5, 35] };

    let lowHitStreak = 0;
    let rawData = [];

    // 核心引擎：帶權重矩陣的策略融合
    function predict(hist, w) {
        if (hist.length < 30) return [1, 2, 3, 4, 5, 6];
        let stats = Array(40).fill(0).map((_, i) => ({ n: i, score: 0 }));
        const lastRow = hist[hist.length - 1].nums;

        // 策略 A: 漏碼動態評分
        for (let i = 1; i <= 39; i++) {
            let gap = 0;
            for (let k = hist.length - 1; k >= 0; k--) {
                if (!hist[k].nums.includes(i)) gap++; else break;
            }
            stats[i].score += (gap <= 10) ? (gap * w.gap) : (42 - gap);
        }

        // 策略 B: 尾數與熱冷碼
        let freq30 = Array(40).fill(0);
        hist.slice(-30).forEach(d => d.nums.forEach(n => freq30[n]++));
        for (let i = 1; i <= 39; i++) {
            stats[i].score += (hist.slice(-20).filter(d => d.nums.some(n => n % 10 === i % 10)).length * w.tail);
            if (freq30[i] >= 7) stats[i].score += w.hotCold;
            if (freq30[i] <= 1) stats[i].score += w.hotCold * 0.7;
        }

        // 策略 C: 空間鄰近性 (鄰號/重號)
        lastRow.forEach(n => {
            if (n > 1) stats[n - 1].score += w.neighbor;
            if (n < 39) stats[n + 1].score += w.neighbor;
            stats[n].score += w.reentry;
        });

        // 多策略挑選與軟性約束
        let final = [];
        let pool = stats.slice(1).sort((a,b) => b.score - a.score);
        for (let i = 0; i < 6; i++) {
            let best = pool[0];
            final.push(best.n);
            pool.shift();
            pool.forEach(c => {
                if (c.n % 10 === best.n % 10) c.score -= 25;
                if (Math.abs(c.n - best.n) === 1) c.score -= 50;
            });
            pool.sort((a,b) => b.score - a.score);
        }
        return final.sort((a,b) => a - b);
    }

    // 強化學習更新：基於 Reward 與梯度下降
    function updateRLWeights(hits, currentW) {
        let nextW = { ...currentW };
        
        // 1. 獎勵機制 (Reward)
        if (hits >= 3) {
            lowHitStreak = 0;
            // 強化成功策略：稍微擴張邊界
            nextW.reentry *= 1.05;
            nextW.neighbor *= 1.02;
        } else if (hits < 1) {
            lowHitStreak++;
        } else {
            lowHitStreak = 0;
        }

        // 2. 策略重置 (避免局部最差)
        if (lowHitStreak >= HYPER.resetThreshold) {
            console.log("觸發策略重置");
            lowHitStreak = 0;
            return { gap: 4.5, tail: 3.2, neighbor: 35.0, reentry: 22.0, hotCold: 15.0 };
        }

        // 3. 擬梯度更新 (Gradient Descent)
        const error = HYPER.targetHit - hits;
        // 根據誤差方向調整各參數
        nextW.gap = clamp(nextW.gap + error * HYPER.lr * 0.5, LIMITS.gap);
        nextW.neighbor = clamp(nextW.neighbor + error * HYPER.lr * 2, LIMITS.neighbor);
        nextW.hotCold = clamp(nextW.hotCold + (error > 0 ? 0.5 : -0.5), LIMITS.hotCold);

        return nextW;
    }

    const clamp = (v, r) => Math.max(r[0], Math.min(r[1], v));

    document.getElementById('csvFile').addEventListener('change', e => {
        const reader = new FileReader();
        reader.onload = () => {
            rawData = reader.result.replace(/\r/g, "").trim().split('\n').map(l => {
                const c = l.split(',');
                return { date: c[0].trim(), nums: c.slice(1, 6).map(x => parseInt(x.trim())).filter(x => !isNaN(x)).sort((a,b)=>a-b) };
            }).filter(r => r.nums.length === 5);
            runEngine();
        };
        reader.readAsText(e.target.files[0]);
    });

    function runEngine() {
        let activeW = { ...weights };
        let results = [];
        let hitHistory = [];
        const scope = 50; // 訓練深度
        const start = Math.max(0, rawData.length - scope);

        for (let i = start; i < rawData.length; i++) {
            const pred = predict(rawData.slice(0, i), activeW);
            const real = rawData[i].nums;
            const hits = real.filter(n => pred.includes(n)).length;

            results.push({ date: rawData[i].date, pred, hits, real });
            hitHistory.push(hits);

            // 每期自動進化權重
            activeW = updateRLWeights(hits, activeW);
        }

        render(results, hitHistory, activeW);
    }

    function render(results, hitHistory, finalW) {
        const avg = (hitHistory.reduce((a,b)=>a+b,0)/hitHistory.length).toFixed(2);
        const variance = (hitHistory.reduce((a,b)=>a+(b-avg)**2,0)/hitHistory.length).toFixed(2);
        
        document.getElementById('weightDisplay').innerHTML = Object.entries(finalW)
            .map(([k,v]) => `<span class="w-chip">${k.toUpperCase()}: ${v.toFixed(2)}</span>`).join('');

        document.getElementById('statsDisplay').innerHTML = `
            <div class="stat-card"><div class="stat-label">強化獎勵 (Reward)</div><div class="stat-val" style="color:var(--primary)">${(avg*10).toFixed(0)} pts</div></div>
            <div class="stat-card"><div class="stat-label">平均命中</div><div class="stat-val">${avg}</div></div>
            <div class="stat-card"><div class="stat-label">命中方差</div><div class="stat-val">${variance}</div></div>
            <div class="stat-card"><div class="stat-label">穩定度(≥2)</div><div class="stat-val">${(hitHistory.filter(h=>h>=2).length/hitHistory.length*100).toFixed(1)}%</div></div>
        `;

        document.getElementById('btBody').innerHTML = results.slice(-8).reverse().map(item => `
            <div class="bt-row">
                <div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:4px;">
                    <span style="color:var(--sub)">${item.date}</span>
                    <span style="color:var(--primary); font-weight:bold;">SCORE: ${item.hits}★</span>
                </div>
                <div style="display:flex; gap:6px;">${item.real.map(n => `<div class="n-box ${item.pred.includes(n)?'hit':''}">${n}</div>`).join('')}</div>
            </div>
        `).join('');

        const next = predict(rawData, finalW);
        document.getElementById('nextPred').innerHTML = next.map(n => `<div class="ball">${n.toString().padStart(2,'0')}</div>`).join('');
        document.getElementById('logBox').innerHTML = `> RL 訓練完成：已執行 ${hitHistory.length} 次權重優化梯度。\n> 當前損失函數穩定度：${(1-variance).toFixed(2)}\n> 連續低命中計數器：${lowHitStreak}\n> 權重已更新至全球最優解矩陣。`;
    }
</script>
</body>
</html>
