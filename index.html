<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>539 策略29回測與最強預測</title>
<style>
:root{
    --ios-blue: #007AFF;
    --ios-green: #34C759;
    --ios-bg: #F2F2F7;
}
body{
    font-family:-apple-system, sans-serif;
    background:var(--ios-bg);
    margin:0;
    padding:15px;
    color:#1C1C1E;
}
.section{
    background:white;
    border-radius:12px;
    padding:16px;
    margin-bottom:15px;
    box-shadow:0 2px 8px rgba(0,0,0,0.05);
}
h3{
    margin-top:0;
    font-size:17px;
    border-bottom:1px solid #EEE;
    padding-bottom:8px;
}
.btn{
    background:var(--ios-green);
    color:white;
    border:none;
    padding:10px;
    width:100%;
    border-radius:10px;
    font-size:14px;
    font-weight:600;
    cursor:pointer;
    margin-top:8px;
}
.prediction-panel{
    margin-top:10px;
    display:flex;
    flex-wrap:wrap;
    gap:5px;
}
.predict-num{
    width:35px;
    height:35px;
    border-radius:50%;
    border:2px solid var(--ios-green);
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:bold;
    color:var(--ios-green);
    background:#EFFFF4;
    font-size:14px;
    cursor:default;
    position:relative;
}
.predict-num:hover::after{
    content: attr(data-hover);
    position:absolute;
    top:-25px;
    left:50%;
    transform:translateX(-50%);
    background:#007AFF;
    color:white;
    padding:2px 6px;
    border-radius:4px;
    font-size:12px;
    white-space:nowrap;
}
input.num-box{
    width:40px;
    text-align:center;
    margin-right:5px;
}
</style>
</head>
<body>

<div class="section">
    <h3>1. 上傳歷史 CSV（截止前天）</h3>
    <input type="file" id="csvInput" accept=".csv">
</div>

<div class="section">
    <h3>2. 輸入昨日開獎號碼（14號）</h3>
    <input type="number" min="1" max="39" class="num-box" id="num1">
    <input type="number" min="1" max="39" class="num-box" id="num2">
    <input type="number" min="1" max="39" class="num-box" id="num3">
    <input type="number" min="1" max="39" class="num-box" id="num4">
    <input type="number" min="1" max="39" class="num-box" id="num5">
</div>

<div class="section">
    <button class="btn" onclick="findStrongestStrategy()">自動選最強策略 & 預測今天號碼</button>
    <div id="strongestPanel" class="prediction-panel" style="margin-top:10px;"></div>
</div>

<div id="strategyPanels"></div>

<script>
let globalData=[];
let strategyResults={};

// 生成策略29 panel
const div=document.createElement('div');
div.className='section';
div.innerHTML=`
    <h3>策略 29</h3>
    <button class="btn" onclick="generateNumbers(29)">產生號碼</button>
    <div id="result-29" class="prediction-panel"></div>
    <div id="hit-29" style="margin-top:5px;font-size:13px;color:#555"></div>
`;
document.getElementById('strategyPanels').appendChild(div);

// CSV 上傳
document.getElementById('csvInput').addEventListener('change',function(e){
    const reader=new FileReader();
    reader.onload=function(event){
        const lines=event.target.result.split('\n').filter(l=>l.trim()!=='');
        globalData=lines.map(line=>line.split(',').map(v=>parseInt(v.trim())).filter(v=>!isNaN(v)));
        alert('CSV 已讀取完成，共 '+globalData.length+' 期資料');
    };
    reader.readAsText(e.target.files[0]);
});

// 檢查號碼有效範圍
function isLotteryNumber(val){return val>=1 && val<=39;}

// 取得昨日號碼陣列
function getTargetNumbers(){
    const nums=[];
    for(let i=1;i<=5;i++){
        const val=parseInt(document.getElementById('num'+i).value);
        if(isLotteryNumber(val)) nums.push(val);
    }
    return nums;
}

// 策略邏輯
function generateNumbers(strategy){
    if(globalData.length===0) return alert('請先上傳 CSV');
    const targetNumbers=getTargetNumbers();
    if(targetNumbers.length!==5) return alert('請輸入完整昨日開獎號碼');

    const allNumbers=globalData.flat().filter(isLotteryNumber);
    let result=[];

    switch(strategy){
        case 29: result=getMirrorTailMix(allNumbers,5); break;
    }

    const hitNumbers=result.filter(n=>targetNumbers.includes(n));
    const hitCount=hitNumbers.length;

    const panelId='result-'+strategy;
    document.getElementById(panelId).innerHTML=result.map(n=>{
        const hoverText=hitNumbers.includes(n)?n:'';
        return `<div class="predict-num" data-hover="${hoverText}">${n}</div>`;
    }).join('');

    document.getElementById('hit-'+strategy).innerText=`命中數：${hitCount} 個`;
    strategyResults[strategy]={result,hitCount};
}

function findStrongestStrategy(){
    const strongest=29;
    const hitCount=strategyResults[strongest]?.hitCount || 0;
    const todayNumbers=strategyResults[strongest]?.result || [];
    const panel=document.getElementById('strongestPanel');
    panel.innerHTML=`最強策略：策略 ${strongest}（昨日命中 ${hitCount}）`+
                    todayNumbers.map(n=>`<div class="predict-num">${n}</div>`).join('');
    alert(`最強策略是策略 ${strongest}，已生成今天號碼建議`);
}

// ===== 策略29輔助函數 =====
function getMirrorTailMix(arr,count){
    // 取最近一次開獎號碼作鏡像尾數混合
    const lastDraw=arr.slice(-5);
    const pool=Array.from({length:39},(_,i)=>i+1);
    const result=[];
    for(let n of lastDraw){
        let mirror=n%10===0 ? n : n+(10-(n%10));
        if(mirror>39) mirror=n-(n%10);
        if(!result.includes(mirror)) result.push(mirror);
        if(result.length>=count) break;
    }
    while(result.length<count){
        const rnd=pool[Math.floor(Math.random()*pool.length)];
        if(!result.includes(rnd)) result.push(rnd);
    }
    return result.slice(0,count);
}
</script>

</body>
</html>
