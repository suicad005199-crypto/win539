<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root { --ios-red: #FF3B30; --ios-yellow: #FFCC00; --ios-blue: #007AFF; --ios-bg: #000; --cell-size: 46px; }
        body { margin: 0; background: var(--ios-bg); color: white; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow: hidden; }
        
        /* æ•…äº‹é–‹å ´ */
        #start-screen { position: fixed; inset: 0; background: #000; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .start-btn { background: none; border: 2px solid var(--ios-blue); color: var(--ios-blue); padding: 12px 40px; border-radius: 30px; font-size: 1.2rem; font-weight: bold; margin-top: 30px; }

        /* é ‚éƒ¨ç‹€æ…‹æ¬„ - å¯¬åº¦åŒæ­¥ */
        #status-bar { width: 96vw; max-width: 450px; padding: 15px 0; display: flex; align-items: center; gap: 10px; }
        .avatar { width: 55px; height: 55px; background: #2c2c2e; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 2rem; border: 1px solid #444; }
        .info-panel { flex: 1; }
        .bar-container { width: 100%; height: 10px; background: #333; border-radius: 5px; overflow: hidden; margin-top: 5px; position: relative; }
        .bar-fill { height: 100%; transition: width 0.3s; }
        .hp-fill { background: var(--ios-red); }
        .exp-fill { background: var(--ios-yellow); }

        /* 8*8 ç¶²æ ¼ - æ”¾å¤§ç‰ˆ */
        .grid-container { position: relative; padding: 4px; background: #1c1c1e; border-radius: 8px; margin-top: 10px; }
        .grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 3px; width: 96vw; max-width: 450px; }
        .cell { aspect-ratio: 1; background: #333; border-radius: 4px; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }
        
        /* ç©å®¶æ‡¸æµ® Token */
        #player-fx-token {
            position: absolute; width: 0; height: 0; /* åˆå§‹ç”± JS è¨­å®š */
            background: var(--ios-blue); border-radius: 4px; z-index: 500;
            display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
            pointer-events: none; transition: transform 0.15s ease-out;
            box-shadow: 0 0 15px rgba(0,122,255,0.6); visibility: hidden;
        }
        .player-static { background: var(--ios-blue) !important; font-size: 1.5rem; }

        /* æ€ªç‰©è¡€æ¢ */
        .mob-bar-bg { width: 85%; height: 4px; background: #000; position: absolute; bottom: 4px; border-radius: 2px; }
        .mob-bar-fill { height: 100%; background: var(--ios-red); width: 100%; }

        /* æˆ°é¬¥æ–‡å­—å½ˆå‡º */
        .dmg-popup {
            position: absolute; font-weight: 900; font-size: 16px; color: var(--ios-red);
            text-shadow: 0 0 4px #000; animation: floatUp 0.6s ease-out forwards; z-index: 600;
        }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-40px); } }

        /* è½‰å ´å‹•ç•« */
        #room-overlay { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 4rem; font-weight: 900; opacity: 0; pointer-events: none; z-index: 1000; }
        .flash { animation: textFlash 1.5s forwards; }
        @keyframes textFlash { 0% { opacity: 0; scale: 0.5; } 50% { opacity: 1; scale: 1.1; } 100% { opacity: 0; scale: 1.5; } }
    </style>
</head>
<body>

    <div id="start-screen">
        <div style="font-size:1.2rem; color:#aaa; line-height:2">
            å¹½æš—çš„è£‚ç¸«ä¸­å‚³ä¾†å˜¶å¼...<br>
            ä½ æ˜¯æœ€å¾Œçš„å®ˆè¡›è€…ã€‚<br>
            é€™æ˜¯ä¸€æ¢æ²’æœ‰å›é ­è·¯çš„å¾é€”ã€‚
        </div>
        <button class="start-btn" onclick="startGame()">é–‹å§‹æ¢ç´¢</button>
    </div>

    <div id="game-ui" style="display:none">
        <div id="status-bar">
            <div class="avatar">ğŸ‘¤</div>
            <div class="info-panel">
                <div style="font-weight:bold; font-size:14px">ç­‰ç´š <span id="pl-lv">1</span> | æ”»æ“Š <span id="pl-atk">15</span></div>
                <div class="bar-container"><div id="hp-bar" class="bar-fill hp-fill" style="width:100%"></div></div>
                <div class="bar-container"><div id="exp-bar" class="bar-fill exp-fill" style="width:0%"></div></div>
            </div>
        </div>

        <div class="grid-container" id="grid-wrap">
            <div id="player-fx-token">ğŸ‘¤</div>
            <div class="grid" id="grid"></div>
        </div>
        <div style="margin-top:20px; color:#555; font-size:12px; font-weight:bold">AREA <span id="room-num">1</span></div>
    </div>

    <div id="room-overlay"></div>

<script>
    let state = { hp: 100, maxHp: 100, exp: 0, nextExp: 100, atk: 15, lv: 1, room: 1, playerPos: 0, isActing: false };
    let map = [];

    function startGame() {
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('game-ui').style.display = 'flex';
        initRoom(true);
    }

    async function initRoom(anim = false) {
        if (anim) {
            const over = document.getElementById('room-overlay');
            over.innerText = `ROOM ${state.room}`;
            over.classList.add('flash');
            await new Promise(r => setTimeout(r, 1500));
            over.classList.remove('flash');
        }

        map = [];
        let pool = ['P', 'B', ...Array(5).fill('H'), ...Array(5).fill('S'), ...Array(52).fill('M')];
        pool.sort(() => Math.random() - 0.5);
        pool.forEach((type, i) => {
            let obj = { type, hp: 0, maxHp: 0 };
            if (type === 'M' || type === 'B') {
                obj.maxHp = obj.hp = (type === 'M' ? 30 : 250) + (state.room * 20);
            }
            if (type === 'P') state.playerPos = i;
            map.push(obj);
        });
        render();
    }

    function render() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        map.forEach((cell, i) => {
            const div = document.createElement('div');
            div.className = `cell ${i === state.playerPos ? 'player-static' : ''}`;
            
            if (i === state.playerPos) div.innerText = 'ğŸ‘¤';
            else if (cell.type === 'M' || cell.type === 'B') {
                div.innerHTML = `<span style="font-size:1.6rem; margin-bottom:5px">${cell.type === 'M'?'ğŸ‘¾':'ğŸ‘¹'}</span>
                                 <div class="mob-bar-bg"><div class="mob-bar-fill" style="width:${(cell.hp/cell.maxHp)*100}%"></div></div>`;
            } else if (cell.type === 'H') div.innerText = 'â¤ï¸';
            else if (cell.type === 'S') div.innerText = 'âš¡';
            
            div.onclick = () => handleAction(i);
            grid.appendChild(div);
        });
        updateUI();
    }

    async function handleAction(target) {
        if (state.isActing || getDist(state.playerPos, target) !== 1) return;
        state.isActing = true;

        const targetObj = map[target];
        const cells = document.querySelectorAll('.cell');
        const pCell = cells[state.playerPos];
        const tCell = cells[target];
        const fxToken = document.getElementById('player-fx-token');

        if (targetObj.hp > 0) {
            // æº–å‚™æ‡¸æµ® Token
            fxToken.style.width = pCell.offsetWidth + 'px';
            fxToken.style.height = pCell.offsetHeight + 'px';
            fxToken.style.left = pCell.offsetLeft + 'px';
            fxToken.style.top = pCell.offsetTop + 'px';
            fxToken.style.visibility = 'visible';
            pCell.style.color = 'transparent';
            pCell.style.background = '#333';

            while (targetObj.hp > 0 && state.hp > 0) {
                // ç©å®¶è¡æ“Šæ€ªç‰© (ä½ç§» 70%)
                const moveX = (tCell.offsetLeft - pCell.offsetLeft) * 0.7;
                const moveY = (tCell.offsetTop - pCell.offsetTop) * 0.7;
                fxToken.style.transform = `translate(${moveX}px, ${moveY}px)`;
                
                targetObj.hp -= state.atk;
                showDmg(tCell, state.atk);
                await new Promise(r => setTimeout(r, 150));
                render();

                if (targetObj.hp <= 0) break;

                // æ€ªç‰©åæ“Š
                fxToken.style.transform = `translate(0, 0)`; // å½ˆå›
                let dmg = Math.max(3, Math.floor(targetObj.hp / 12));
                state.hp -= dmg;
                showDmg(fxToken, dmg);
                updateUI();
                await new Promise(r => setTimeout(r, 150));
            }

            if (state.hp > 0) {
                state.exp += (targetObj.type === 'B' ? 120 : 40);
                if (state.exp >= state.nextExp) levelUp();
                if (targetObj.type === 'B') {
                    state.room++;
                    fxToken.style.visibility = 'hidden';
                    await initRoom(true);
                } else {
                    movePlayer(target);
                }
            }
        } else {
            if (targetObj.type === 'H') state.hp = Math.min(state.maxHp, state.hp + 30);
            if (targetObj.type === 'S') state.atk += 4;
            movePlayer(target);
        }

        if (state.hp <= 0) { alert("å†’éšªåœ¨æ­¤çµ‚çµ..."); location.reload(); }
        
        fxToken.style.visibility = 'hidden';
        state.isActing = false;
        render();
    }

    function showDmg(el, val) {
        const d = document.createElement('div');
        d.className = 'dmg-popup';
        d.innerText = `-${val}`;
        d.style.left = '50%';
        d.style.marginLeft = '-10px';
        el.appendChild(d);
        setTimeout(() => d.remove(), 600);
    }

    function movePlayer(t) {
        map[state.playerPos] = { type: 'E' };
        state.playerPos = t;
        map[state.playerPos] = { type: 'P' };
    }

    function levelUp() {
        state.lv++; state.exp = 0; state.nextExp += 50; state.atk += 6; state.maxHp += 25;
    }

    function getDist(p1, p2) {
        return Math.abs(p1 % 8 - p2 % 8) + Math.abs(Math.floor(p1 / 8) - Math.floor(p2 / 8));
    }

    function updateUI() {
        document.getElementById('hp-bar').style.width = `${(state.hp/state.maxHp)*100}%`;
        document.getElementById('exp-bar').style.width = `${(state.exp/state.nextExp)*100}%`;
        document.getElementById('pl-lv').innerText = state.lv;
        document.getElementById('pl-atk').innerText = state.atk;
        document.getElementById('room-num').innerText = state.room;
    }
</script>
</body>
</html>
