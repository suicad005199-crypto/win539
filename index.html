<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>多策略模擬下一組號碼</title>
<style>
body { font-family: Arial, sans-serif; background-color: #1a1f36; color: #f0f0f0; padding: 20px; }
h1 { color: #4fc3f7; text-align: center; }
input, button { font-size: 20px; padding: 15px; margin: 10px 0; border-radius: 12px; border: none; width: 100%; box-sizing: border-box; }
button { background-color: #4fc3f7; color: #1a1f36; cursor: pointer; }
#result { margin-top: 20px; font-size: 22px; text-align: center; }
table { width: 100%; border-collapse: collapse; margin-top: 20px; }
th, td { padding: 10px; text-align: center; border: 1px solid #4fc3f7; }
</style>
</head>
<body>

<h1>多策略模擬下一組號碼</h1>
<p>上傳 CSV 文件（每行一組號碼，用逗號分隔）</p>
<input type="file" id="csvFile" accept=".csv">
<button onclick="generate()">生成下一組號碼</button>

<div id="result"></div>

<script>
function generate() {
    const fileInput = document.getElementById('csvFile');
    if (!fileInput.files.length) { alert("請先上傳 CSV"); return; }

    const reader = new FileReader();
    reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.trim().split(/\r?\n/);
        let data = [];
        let allNumbers = [];

        lines.forEach(line => {
            const nums = line.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
            if(nums.length) {
                data.push(nums);
                allNumbers.push(...nums);
            }
        });

        // 計算頻率
        let freq = {};
        allNumbers.forEach(n => { freq[n] = (freq[n] || 0) + 1; });
        let maxFreq = Math.max(...Object.values(freq));
        let freqScore = {};
        for(let i=1;i<=39;i++){ freqScore[i] = (freq[i]||0)/maxFreq; }

        // 計算奇偶偏好
        let oddCounts = data.map(row => row.filter(n=>n%2===1).length);
        let avgOdd = Math.round(oddCounts.reduce((a,b)=>a+b,0)/oddCounts.length);

        // 計算和值範圍
        let sums = data.map(row=>row.reduce((a,b)=>a+b,0));
        let meanSum = Math.round(sums.reduce((a,b)=>a+b,0)/sums.length);
        let stdSum = Math.round(Math.sqrt(sums.map(s=>(s-meanSum)**2).reduce((a,b)=>a+b,0)/sums.length));

        // 計算跨度
        let spans = data.map(row=>Math.max(...row)-Math.min(...row));
        let avgSpan = Math.round(spans.reduce((a,b)=>a+b,0)/spans.length);

        // 計算每個號碼總得分（頻率 + 是否在奇偶偏好範圍）
        let score = {};
        for(let i=1;i<=39;i++){
            score[i] = freqScore[i]; // 可擴充加權其他條件
        }

        // 選出分數最高 5 個號碼
        let nextDraw = Object.keys(score)
                            .sort((a,b)=>score[b]-score[a])
                            .slice(0,5)
                            .map(Number)
                            .sort((a,b)=>a-b);

        // 調整奇偶比，盡量接近歷史平均
        let oddCount = nextDraw.filter(n=>n%2===1).length;
        if(oddCount != avgOdd){
            // 嘗試替換號碼調整奇偶
            for(let i=0;i<nextDraw.length;i++){
                let n = nextDraw[i];
                if(oddCount>avgOdd && n%2===1){
                    for(let candidate=1;candidate<=39;candidate++){
                        if(!nextDraw.includes(candidate) && candidate%2===0){
                            nextDraw[i]=candidate; oddCount--; break;
                        }
                    }
                } else if(oddCount<avgOdd && n%2===0){
                    for(let candidate=1;candidate<=39;candidate++){
                        if(!nextDraw.includes(candidate) && candidate%2===1){
                            nextDraw[i]=candidate; oddCount++; break;
                        }
                    }
                }
                if(oddCount===avgOdd) break;
            }
            nextDraw.sort((a,b)=>a-b);
        }

        document.getElementById('result').innerHTML = `<h2>下一組號碼:</h2><p>${nextDraw.join(', ')}</p>`;
    };
    reader.readAsText(fileInput.files[0]);
}
</script>

</body>
</html>
