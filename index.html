<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>539 ç¥ç¶“å…ƒå¼•æ“ V.43.0 - è‡ªå‹•é§•é§›ç‰ˆ</title>
    <style>
        :root { --bg: #0b0b0d; --panel: #1c1c1e; --primary: #ffd60a; --border: #38383a; --text: #fff; --sub: #8e8e93; --hit: #ff375f; --accent: #0a84ff; --success: #32d74b; --warning: #ff9f0a; }
        body { font-family: 'SF Pro Display', 'PingFang TC', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; font-size: 13px; }
        .container { display: flex; flex-direction: column; gap: 12px; }
        .panel { background: var(--panel); border-radius: 12px; padding: 12px; border: 1px solid var(--border); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .panel-header { color: var(--primary); font-weight: bold; margin-bottom: 10px; border-left: 3px solid var(--primary); padding-left: 8px; font-size: 14px; display: flex; justify-content: space-between; }
        
        /* è‡ªå‹•åŒ–çµ±è¨ˆé¡¯ç¤º */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
        .stat-card { background: rgba(255,255,255,0.05); padding: 8px; border-radius: 6px; border: 1px solid var(--border); }
        .stat-label { font-size: 10px; color: var(--sub); margin-bottom: 2px; }
        .stat-val { font-size: 14px; font-weight: bold; color: var(--success); }

        /* æ¬Šé‡ç›£è¦–å™¨ */
        .weight-tag { font-size: 10px; background: #2c2c2e; padding: 2px 6px; border-radius: 4px; color: var(--accent); margin-right: 4px; }

        .bt-row { border-bottom: 1px solid var(--border); padding: 10px 0; display: flex; flex-direction: column; gap: 6px; }
        .bt-meta { display: flex; justify-content: space-between; color: var(--sub); font-size: 11px; }
        .n-box { width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; border-radius: 4px; background: #2c2c2e; font-size: 11px; font-weight: bold; }
        .n-box.hit { background: var(--primary); color: #000; box-shadow: 0 0 8px var(--primary); }
        
        .log-box { background: #000; color: var(--success); padding: 10px; height: 100px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 11px; border: 1px solid var(--border); line-height: 1.5; }
        .ball-row { display: flex; flex-wrap: wrap; gap: 6px; }
        .ball { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #2c2c2e; border-radius: 50%; font-weight: 900; border: 2px solid var(--accent); color: var(--accent); font-size: 18px; box-shadow: 0 0 10px rgba(10,132,255,0.3); }
    </style>
</head>
<body>
<div class="container">
    <div class="panel">
        <div class="panel-header">æ§åˆ¶å° <span>ENGINE: V.43.0</span></div>
        <input type="file" id="csvFile" accept=".csv" style="font-size: 12px;">
    </div>
    
    <div class="panel">
        <div class="panel-header">è‡ªé©æ‡‰æ¬Šé‡ç›£è¦– (Learning Status)</div>
        <div id="weightDisplay" style="margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 4px;"></div>
        <div id="statsDisplay" class="stats-grid"></div>
    </div>

    <div class="panel">
        <div class="panel-header">å›æ¸¬å¯¦æ³ (è¨“ç·´è¿­ä»£)</div>
        <div id="btBody"></div>
    </div>

    <div class="panel">
        <div class="panel-header">ä¸‹æœŸé æ¸¬ (æœ€ä½³æ¬Šé‡ç”¢å‡º)</div>
        <div id="nextPred" class="ball-row"></div>
    </div>

    <div class="panel">
        <div id="logBox" class="log-box">ç¥ç¶“å…ƒå¼•æ“å·²å°±ç·’ï¼Œç­‰å¾…æ•¸æ“šé©…å‹•è‡ªæˆ‘å­¸ç¿’...</div>
    </div>
</div>

<script>
    // åˆå§‹æ¬Šé‡åƒæ•¸ (åƒæ•¸åŒ–ç®¡ç†)
    let weights = {
        gap: 4.2,
        tail: 3.5,
        neighbor: 32.0,
        reentry: 25.0,
        hotCold: 18.0
    };

    const LIMITS = { gap: [2, 7], tail: [1.5, 6], neighbor: [10, 50], reentry: [10, 40], hotCold: [5, 30] };
    const LEARNING_RATE = 0.05; // æ¬Šé‡æ›´æ–°æ­¥é•·

    let rawData = [];

    // æ ¸å¿ƒé æ¸¬å¼•æ“ (æ¨¡çµ„åŒ–ç­–ç•¥)
    function predict(hist, currentWeights) {
        if (hist.length < 30) return [1, 2, 3, 4, 5, 6];
        let stats = Array(40).fill(0).map((_, i) => ({ n: i, score: 0 }));
        const lastRow = hist[hist.length - 1].nums;

        // ç†±å†·ç¢¼çµ±è¨ˆ
        let freqMap = Array(40).fill(0);
        hist.slice(-30).forEach(d => d.nums.forEach(n => freqMap[n]++));

        for (let i = 1; i <= 39; i++) {
            // ç­–ç•¥ A: æ¼ç¢¼ (Gap)
            let gap = 0;
            for (let k = hist.length - 1; k >= 0; k--) {
                if (!hist[k].nums.includes(i)) gap++; else break;
            }
            stats[i].score += (gap <= 12) ? (gap * currentWeights.gap) : (40 - gap);

            // ç­–ç•¥ B: å°¾æ•¸ (Tail)
            let tailFreq = hist.slice(-20).filter(d => d.nums.some(n => n % 10 === i % 10)).length;
            stats[i].score += tailFreq * currentWeights.tail;

            // ç­–ç•¥ C: ç†±å†·åŠ æ¬Š
            if (freqMap[i] >= 6) stats[i].score += currentWeights.hotCold;
            if (freqMap[i] <= 1) stats[i].score += currentWeights.hotCold * 0.7;
        }

        // ç­–ç•¥ D: é„°è™Ÿèˆ‡é‡è™Ÿ
        lastRow.forEach(n => {
            if (n > 1) stats[n - 1].score += currentWeights.neighbor;
            if (n < 39) stats[n + 1].score += currentWeights.neighbor;
            stats[n].score += currentWeights.reentry;
        });

        // æŒ‘é¸é‚è¼¯ (è»Ÿæ€§æ‡²ç½°)
        let finalSix = [];
        let candidates = stats.slice(1).sort((a, b) => b.score - a.score);
        for (let i = 0; i < 6; i++) {
            let best = candidates[0];
            finalSix.push(best.n);
            candidates.shift();
            candidates.forEach(c => {
                if (c.n % 10 === best.n % 10) c.score -= 20;
                if (Math.abs(c.n - best.n) === 1) c.score -= 45;
            });
            candidates.sort((a, b) => b.score - a.score);
        }
        return finalSix.sort((a, b) => a - b);
    }

    // æ¬Šé‡è‡ªå‹•å„ªåŒ–å™¨ (è¨“ç·´è¿´åœˆ)
    function optimizeWeights(hits, currentWeights) {
        let newWeights = { ...currentWeights };
        // ç°¡å–®å›é¥‹æ©Ÿåˆ¶ï¼šå¦‚æœå‘½ä¸­ä½æ–¼å¹³å‡ï¼Œå¾®èª¿æ²¹é–€èˆ‡å‰è»Š
        if (hits < 1.8) {
            newWeights.gap = clamp(newWeights.gap + (Math.random() - 0.3) * LEARNING_RATE, LIMITS.gap);
            newWeights.neighbor = clamp(newWeights.neighbor - LEARNING_RATE * 5, LIMITS.neighbor);
        } else if (hits >= 3) {
            // å‘½ä¸­é«˜å‰‡å¼·åŒ–ç•¶å‰æˆåŠŸçš„åƒæ•¸æ–¹å‘
            newWeights.reentry = clamp(newWeights.reentry + LEARNING_RATE * 2, LIMITS.reentry);
        }
        return newWeights;
    }

    const clamp = (v, range) => Math.max(range[0], Math.min(range[1], v));

    document.getElementById('csvFile').addEventListener('change', e => {
        const reader = new FileReader();
        reader.onload = () => {
            rawData = reader.result.replace(/\r/g, "").trim().split('\n').map(l => {
                const c = l.split(',');
                return { date: c[0].trim(), nums: c.slice(1, 6).map(x => parseInt(x.trim())).filter(x => !isNaN(x)).sort((a,b)=>a-b) };
            }).filter(r => r.nums.length === 5);
            runNeuronEngine();
        };
        reader.readAsText(e.target.files[0]);
    });

    function runNeuronEngine() {
        let activeWeights = { ...weights };
        let results = [];
        let hitHistory = [];
        const trainScope = 40;
        const start = Math.max(0, rawData.length - trainScope);

        for (let i = start; i < rawData.length; i++) {
            // 1. å³æ™‚é æ¸¬
            const pred = predict(rawData.slice(0, i), activeWeights);
            const real = rawData[i].nums;
            const hits = real.filter(n => pred.includes(n)).length;

            // 2. å­˜å„²çµæœ
            results.push({ date: rawData[i].date, pred, hits, real, w: { ...activeWeights } });
            hitHistory.push(hits);

            // 3. è‡ªå‹•æ›´æ–°æ¬Šé‡ (å­¸ç¿’éšæ®µ)
            activeWeights = optimizeWeights(hits, activeWeights);
        }

        // æ¸²æŸ“ UI
        renderUI(results, hitHistory, activeWeights);
    }

    function renderUI(results, hitHistory, finalWeights) {
        const avg = (hitHistory.reduce((a, b) => a + b, 0) / hitHistory.length).toFixed(2);
        const variance = (hitHistory.reduce((a, b) => a + (b - avg) ** 2, 0) / hitHistory.length).toFixed(2);
        const loss = (-avg + variance * 0.5).toFixed(2);

        // é¡¯ç¤ºæ¬Šé‡ç‹€æ…‹
        document.getElementById('weightDisplay').innerHTML = Object.entries(finalWeights)
            .map(([k, v]) => `<span class="weight-tag">${k.toUpperCase()}: ${v.toFixed(2)}</span>`).join('');

        document.getElementById('statsDisplay').innerHTML = `
            <div class="stat-card"><div class="stat-label">Loss (æ„ˆä½æ„ˆå¥½)</div><div class="stat-val">${loss}</div></div>
            <div class="stat-card"><div class="stat-label">å¹³å‡å‘½ä¸­</div><div class="stat-val">${avg}</div></div>
            <div class="stat-card"><div class="stat-label">å‘½ä¸­æ–¹å·®</div><div class="stat-val">${variance}</div></div>
            <div class="stat-card"><div class="stat-label">ç©©å®šåº¦(â‰¥2)</div><div class="stat-val">${(hitHistory.filter(h=>h>=2).length/hitHistory.length*100).toFixed(1)}%</div></div>
        `;

        document.getElementById('btBody').innerHTML = results.slice(-10).reverse().map(item => `
            <div class="bt-row">
                <div class="bt-meta">ğŸ“… ${item.date} <span style="color:var(--warning)">Score: ${item.hits}â˜…</span></div>
                <div style="display:flex; gap:4px;">${item.real.map(n => `<div class="n-box ${item.pred.includes(n)?'hit':''}">${n}</div>`).join('')}</div>
            </div>
        `).join('');

        const next = predict(rawData, finalWeights);
        document.getElementById('nextPred').innerHTML = next.map(n => `<div class="ball">${n.toString().padStart(2,'0')}</div>`).join('');
        
        document.getElementById('logBox').innerHTML = `> å­¸ç¿’å®Œç•¢ï¼šå·²éæ­· ${hitHistory.length} å€‹è¨“ç·´æ¨£æœ¬\n> æå¤±å‡½æ•¸å„ªåŒ–ä¸­... ç›®å‰å€¼: ${loss}\n> æ¬Šé‡å·²åŒæ­¥è‡³ä¸‹ä¸€æœŸé æ¸¬å¼•æ“ã€‚`;
    }
</script>
</body>
</html>
