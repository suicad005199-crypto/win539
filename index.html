<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root { --ios-blue: #007AFF; --ios-red: #FF3B30; --ios-green: #4CD964; --ios-gold: #FFD700; }
        body { margin: 0; background: #1c1c1e; color: white; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; padding-top: 10px; overflow: hidden; }
        
        /* ç‹€æ…‹æ¬„ */
        #header { width: 90vw; max-width: 400px; display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 10px; }
        .hp-bar-bg { width: 120px; height: 10px; background: #3a3a3c; border-radius: 5px; overflow: hidden; }
        #hp-fill { width: 100%; height: 100%; background: var(--ios-green); transition: width 0.3s; }
        
        /* ç¶²æ ¼ */
        .grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; width: 95vw; max-width: 400px; background: #2c2c2e; padding: 6px; border-radius: 12px; position: relative; }
        .cell { aspect-ratio: 1; background: #444; border-radius: 4px; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 1.2rem; transition: transform 0.1s; position: relative; }
        .player { background: var(--ios-blue) !important; z-index: 10; font-size: 1.5rem; }
        .mob-hp { font-size: 8px; color: #ff9999; margin-top: 2px; font-weight: bold; }
        
        /* ç¢°æ’å‹•ç•« */
        .bump { transform: scale(1.2); z-index: 11; }
        
        /* Slot */
        #slot-area { margin-top: 15px; text-align: center; }
        .slot-box { display: inline-flex; gap: 5px; background: #000; padding: 8px; border-radius: 8px; border: 1px solid var(--ios-gold); margin-bottom: 5px; }
        .s-item { width: 40px; height: 40px; background: #222; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .spin-btn { background: var(--ios-gold); border: none; padding: 8px 20px; border-radius: 15px; font-weight: bold; opacity: 0.3; }
        .active { opacity: 1; }
    </style>
</head>
<body>

<div id="header">
    <div>
        <div style="font-size: 12px;">ROOM <span id="room-lv">1</span></div>
        <div style="font-size: 14px; font-weight: bold;">HP <span id="hp-txt">100</span></div>
        <div class="hp-bar-bg"><div id="hp-fill"></div></div>
    </div>
    <div style="text-align: right;">
        <span style="color:var(--ios-gold)">ATK: <span id="atk">10</span></span><br>
        <span style="font-size: 12px;">LV: <span id="pl-lv">1</span></span>
    </div>
</div>

<div class="grid" id="grid"></div>

<div id="slot-area">
    <div class="slot-box" id="slots">
        <div class="s-item">â“</div><div class="s-item">â“</div><div class="s-item">â“</div>
    </div><br>
    <button id="spin-btn" class="spin-btn" onclick="runSpin()">SPIN (<span id="spins">0</span>)</button>
</div>

<script>
    let state = { hp: 100, maxHp: 100, atk: 10, lv: 1, room: 1, spins: 0, playerPos: 0 };
    let map = [];
    const gridEl = document.getElementById('grid');

    function initRoom() {
        map = [];
        // ç”Ÿæˆåœ°åœ–è³‡æ–™ï¼š1P, 1Boss, 5Heal, 5Buff, å…¶é¤˜æ€ª
        let pool = ['P', 'B', ...Array(5).fill('H'), ...Array(5).fill('S'), ...Array(52).fill('M')];
        pool = pool.sort(() => Math.random() - 0.5);
        
        pool.forEach((type, i) => {
            let obj = { type, hp: 0 };
            if (type === 'M') obj.hp = 15 + (state.room * 5);
            if (type === 'B') obj.hp = 100 + (state.room * 20);
            if (type === 'P') state.playerPos = i;
            map.push(obj);
        });
        render();
    }

    function render() {
        gridEl.innerHTML = '';
        map.forEach((cell, i) => {
            const div = document.createElement('div');
            const dist = getDist(state.playerPos, i);
            div.className = `cell ${i === state.playerPos ? 'player' : ''}`;
            
            if (i === state.playerPos) div.innerHTML = 'ğŸ‘¤';
            else if (cell.type === 'M') div.innerHTML = `ğŸ‘¾<div class="mob-hp">${cell.hp}</div>`;
            else if (cell.type === 'B') div.innerHTML = `ğŸ‘¹<div class="mob-hp">BOSS:${cell.hp}</div>`;
            else if (cell.type === 'H') div.innerHTML = 'â¤ï¸';
            else if (cell.type === 'S') div.innerHTML = 'âš¡';
            else if (cell.type === 'E') div.innerHTML = '';

            div.onclick = () => handleAction(i);
            gridEl.appendChild(div);
        });
        updateUI();
    }

    async function handleAction(target) {
        if (getDist(state.playerPos, target) !== 1) return;
        
        const targetObj = map[target];
        const playerDiv = gridEl.children[state.playerPos];

        // ç¢°æ’å‹•ç•«
        playerDiv.classList.add('bump');
        await new Promise(r => setTimeout(r, 100));
        playerDiv.classList.remove('bump');

        if (targetObj.type === 'M' || targetObj.type === 'B') {
            // æˆ°é¬¥é‚è¼¯
            targetObj.hp -= state.atk;
            state.hp -= Math.floor(targetObj.hp / 5); // æ€ªç‰©åæ“Šå‚·å®³åŸºæ–¼å‰©é¤˜è¡€é‡

            if (targetObj.hp <= 0) {
                if (targetObj.type === 'B') {
                    alert(`æ­å–œé€šé Room ${state.room}ï¼é€²å…¥ä¸‹ä¸€å±¤ã€‚`);
                    state.room++;
                    initRoom();
                    return;
                }
                if (Math.random() < 0.3) state.spins++;
                state.lv++;
                movePlayer(target);
            }
        } else if (targetObj.type === 'H') {
            state.hp = Math.min(state.maxHp, state.hp + 20);
            movePlayer(target);
        } else if (targetObj.type === 'S') {
            state.atk += 5;
            movePlayer(target);
        } else {
            movePlayer(target);
        }

        if (state.hp <= 0) {
            alert("ä½ å·²é™£äº¡ï¼åœ°åœ–é‡ç½®ã€‚");
            location.reload();
        }
        render();
    }

    function movePlayer(target) {
        map[state.playerPos] = { type: 'E' };
        state.playerPos = target;
        map[state.playerPos] = { type: 'P' };
    }

    function getDist(p1, p2) {
        const x1 = p1 % 8, y1 = Math.floor(p1 / 8);
        const x2 = p2 % 8, y2 = Math.floor(p2 / 8);
        return Math.abs(x1 - x2) + Math.abs(y1 - y2);
    }

    function runSpin() {
        if (state.spins <= 0) return;
        state.spins--;
        const items = ['ğŸ','âš”ï¸','ğŸ’£'];
        const res = [items[Math.floor(Math.random()*3)], items[Math.floor(Math.random()*3)], items[Math.floor(Math.random()*3)]];
        
        const boxes = document.querySelectorAll('.s-item');
        res.forEach((symbol, i) => boxes[i].innerText = symbol);

        if (res[0] === res[1] && res[1] === res[2]) {
            if (res[0] === 'ğŸ') { state.maxHp += 30; state.hp = state.maxHp; alert("å¤§çï¼šHPä¸Šé™æå‡ä¸¦è£œæ»¿ï¼"); }
            if (res[0] === 'âš”ï¸') { state.atk += 15; alert("å¤§çï¼šATKå¤§å¹…æå‡ï¼"); }
            if (res[0] === 'ğŸ’£') { 
                map.forEach(c => { if(c.type === 'M') c.hp = Math.floor(c.hp/2); });
                alert("å¤§çï¼šå…¨å ´æ€ªç‰© HP æ¸›åŠï¼");
            }
        }
        render();
    }

    function updateUI() {
        document.getElementById('hp-fill').style.width = `${(state.hp/state.maxHp)*100}%`;
        document.getElementById('hp-txt').innerText = state.hp;
        document.getElementById('atk').innerText = state.atk;
        document.getElementById('pl-lv').innerText = state.lv;
        document.getElementById('room-lv').innerText = state.room;
        document.getElementById('spins').innerText = state.spins;
        document.getElementById('spin-btn').className = `spin-btn ${state.spins > 0 ? 'active' : ''}`;
    }

    initRoom();
</script>
</body>
</html>
