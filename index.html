<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Demo 系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #000; color: #fff; -webkit-tap-highlight-color: transparent; }
        .ios-blur { backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); }
        .panel { @apply bg-zinc-900/50 border border-zinc-800 rounded-2xl p-4 mb-4; }
        .orange-btn { @apply bg-orange-500 text-black font-black py-3 rounded-xl active:scale-95 transition-all; }
        .tag-hit { @apply bg-orange-500 text-black text-[10px] px-1 rounded font-bold; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
    </style>
</head>
<body class="pb-20">

    <div class="sticky top-0 z-50 bg-black/80 ios-blur border-b border-zinc-800 px-6 py-4 flex justify-between items-center">
        <h1 class="text-xl font-black text-orange-500 tracking-tighter">539 AI PRO</h1>
        <div class="flex gap-2">
            <button onclick="switchSource('539')" id="t-539" class="text-xs font-bold text-orange-500">今彩</button>
            <span class="text-zinc-700">|</span>
            <button onclick="switchSource('fantasy5')" id="t-fa" class="text-xs font-bold text-zinc-500">天天樂</button>
        </div>
    </div>

    <div class="p-4">
        <div class="panel">
            <h3 class="text-[10px] text-zinc-500 font-bold mb-2 uppercase">Panel 1: System Logs</h3>
            <div id="logbox" class="h-24 overflow-y-auto font-mono text-[10px] text-green-500 bg-black/50 p-2 rounded-lg border border-zinc-800">
                > 系統準備就緒...<br>
                > 等待同步 API 數據...
            </div>
        </div>

        <div class="panel">
            <h3 class="text-[10px] text-orange-500 font-bold mb-3 uppercase">Panel 2: Next Prediction (2026-02-10)</h3>
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-bold text-zinc-300">連碰 (5碼)</span>
                    <div id="pred-combo" class="flex gap-1 text-orange-500 font-mono font-bold text-lg">-- -- -- -- --</div>
                </div>
                <div class="flex items-center justify-between border-t border-zinc-800 pt-3">
                    <span class="text-sm font-bold text-zinc-300">立柱 (2:3)</span>
                    <div id="pred-column" class="flex gap-2 items-center">
                        <span id="col-1" class="text-white font-mono font-bold bg-zinc-800 px-2 py-1 rounded">--</span>
                        <span class="text-orange-500 font-black">|</span>
                        <span id="col-2" class="text-white font-mono font-bold bg-zinc-800 px-2 py-1 rounded">--</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel border-red-900/30">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-[10px] text-red-500 font-bold uppercase">Panel 4: 五碼不中預測</h3>
                <span class="text-[9px] text-zinc-600">避開熱門與拖牌號</span>
            </div>
            <div id="pred-miss" class="flex justify-between px-2 font-mono text-xl font-bold text-zinc-500">
                <span>--</span><span>--</span><span>--</span><span>--</span><span>--</span>
            </div>
        </div>

        <div class="panel">
            <h3 class="text-[10px] text-blue-500 font-bold mb-3 uppercase">Panel 3: Backtest Results</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-[10px] text-left">
                    <thead>
                        <tr class="text-zinc-500 border-b border-zinc-800">
                            <th class="pb-2">日期</th>
                            <th class="pb-2">開獎</th>
                            <th class="pb-2">AI 預測</th>
                            <th class="pb-2">結果</th>
                        </tr>
                    </thead>
                    <tbody id="backtest-body" class="divide-y divide-zinc-800">
                        <tr><td colspan="4" class="py-4 text-center text-zinc-600 italic">暫無回測數據，請點擊同步</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <button onclick="fetchData()" class="orange-btn w-full shadow-lg shadow-orange-900/20">
            同步數據並執行 AI 分析
        </button>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxX4EPXapWEH0l7yodiQjAquQQMNq73WkChSIuWnsd3_p59grPf9AKsrN32TtMXydBa-A/exec';
        let currentSource = '539';

        function log(msg) {
            const lb = document.getElementById('logbox');
            lb.innerHTML += `> ${msg}<br>`;
            lb.scrollTop = lb.scrollHeight;
        }

        async function fetchData() {
            log(`正在抓取 ${currentSource} 歷史數據...`);
            try {
                const response = await fetch(`${API_URL}?sheet=${currentSource}`);
                const data = await response.json();
                log(`同步成功，共 ${data.length} 期資料。`);
                runAI(data);
            } catch (e) {
                log(`<span class="text-red-500">錯誤: API 請求失敗</span>`);
            }
        }

        function runAI(data) {
            log("開始進行頻率、尾數、奇偶特徵提取...");
            const freq = {};
            const tails = {};
            data.forEach(r => {
                [r.num1, r.num2, r.num3, r.num4, r.num5].forEach(n => {
                    freq[n] = (freq[n] || 0) + 1;
                    const t = parseInt(n) % 10;
                    tails[t] = (tails[t] || 0) + 1;
                });
            });

            // 1. 預測牌組 (連碰 5 碼)
            const sortedNums = Object.keys(freq).sort((a,b) => freq[b] - freq[a]);
            const best5 = sortedNums.slice(0, 5).sort();
            document.getElementById('pred-combo').innerText = best5.join(' ');
            log(`產出最優五碼: ${best5.join(',')}`);

            // 2. 立柱預測 (2:3)
            document.getElementById('col-1').innerText = `${best5[0]},${best5[1]}`;
            document.getElementById('col-2').innerText = `${best5[2]},${best5[3]},${best5[4]}`;

            // 3. 五碼不中 (取頻率最低且非近期尾數)
            const miss5 = Object.keys(freq).sort((a,b) => freq[a] - freq[b]).slice(0, 5).sort();
            const missContainer = document.getElementById('pred-miss');
            missContainer.innerHTML = miss5.map(m => `<span>${m}</span>`).join('');

            // 4. 回測 (顯示最近 5 期)
            const tbody = document.getElementById('backtest-body');
            tbody.innerHTML = '';
            data.slice(0, 5).forEach((row, index) => {
                const winNums = [row.num1, row.num2, row.num3, row.num4, row.num5].map(String);
                // 模擬 AI 之前可能的預測 (回測邏輯簡化：使用該期後的統計結果模擬)
                const hitCount = best5.filter(n => winNums.includes(n.padStart(2, '0')) || winNums.includes(parseInt(n).toString())).length;
                
                const tr = document.createElement('tr');
                tr.className = "border-b border-zinc-800";
                tr.innerHTML = `
                    <td class="py-3 text-zinc-400">${row.date.split('T')[0]}</td>
                    <td class="py-3 font-mono">${winNums.join(',')}</td>
                    <td class="py-3 text-zinc-500">${best5.slice(0,2).join(',')}...</td>
                    <td class="py-3">${hitCount > 0 ? `<span class="tag-hit">${hitCount}星</span>` : '摃'}</td>
                `;
                tbody.appendChild(tr);
            });
            log("回測分析完成。");
        }

        function switchSource(s) {
            currentSource = s;
            document.getElementById('t-539').className = s==='539' ? "text-xs font-bold text-orange-500" : "text-xs font-bold text-zinc-500";
            document.getElementById('t-fa').className = s==='fantasy5' ? "text-xs font-bold text-orange-500" : "text-xs font-bold text-zinc-500";
            log(`切換數據源至: ${s}`);
            fetchData();
        }

        // 初始化
        initGrid = () => {}; // 覆蓋舊版
    </script>
</body>
</html>

