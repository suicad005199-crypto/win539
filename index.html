<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ULTIMATE EVO 7.30 CORE FUSION</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root { --ios-orange: #f97316; --ios-bg: #000000; --ios-panel: #1c1c1e; }
body { background-color: var(--ios-bg); color: #fff; font-family: -apple-system, system-ui; overflow: hidden; }
.ios-panel { background: var(--ios-panel); border-radius: 12px; }
.orange-glow { box-shadow: 0 0 25px rgba(249, 115, 22, 0.4); }
.btn-active { background: var(--ios-orange); color: #000; font-weight: 700; }
.btn-inactive { background: #2c2c2e; color: var(--ios-orange); }
#logBox { font-variant-numeric: tabular-nums; scrollbar-width: none; }
#logBox::-webkit-scrollbar { display: none; }
.hit-num { color: var(--ios-orange); font-weight: 900; text-decoration: underline; }
</style>
</head>
<body class="h-screen flex flex-col p-4">

<div class="flex justify-between items-center mb-5">
    <h1 class="text-2xl font-black italic tracking-tighter text-orange-500">ULTIMATE <span class="text-white">EVO 7.30</span></h1>
    <div class="flex bg-[#2c2c2e] p-1 rounded-xl flex-nowrap shrink-0">
        <button id="btn539" class="px-4 py-1.5 rounded-lg text-sm btn-active whitespace-nowrap">今彩539</button>
        <button id="btnDaily" class="px-4 py-1.5 rounded-lg text-sm btn-inactive ml-1 whitespace-nowrap">天天樂</button>
    </div>
</div>

<div class="ios-panel p-4 mb-4 orange-glow border border-orange-500/30">
    <div class="flex justify-between items-end mb-2">
        <label class="text-[10px] text-gray-400 font-bold uppercase tracking-widest text-orange-400">Panel 1: CORE-FUSION 權重聚變引擎</label>
        <div id="syncStatus" class="flex items-center text-[10px] text-orange-500 font-bold uppercase">
            <span class="w-2 h-2 bg-orange-500 rounded-full mr-1 animate-pulse"></span> ANTI-ZERO DEFENSE ACTIVE
        </div>
    </div>
    <div id="logBox" class="bg-black/50 p-3 rounded-lg text-[11px] h-28 overflow-y-auto font-mono border border-white/5 leading-relaxed">
        <span class="text-orange-500/50 italic">檢測到 v7.20 穩定基底，正在進行火力收斂...</span>
    </div>
</div>

<div class="ios-panel p-4 mb-4 border-t-2 border-orange-500">
    <label class="text-[10px] text-gray-400 font-bold uppercase tracking-widest block mb-3">Panel 3: 聚變輸出 (Precision Focus)</label>
    <div class="grid grid-cols-4 gap-2">
        <div class="bg-orange-500/10 p-2 rounded-lg text-center border border-orange-500/30">
            <div class="text-[9px] text-orange-500 font-bold">絕對核心</div>
            <div class="text-lg font-black text-white" id="p1">--</div>
        </div>
        <div class="bg-orange-500/10 p-2 rounded-lg text-center border border-orange-500/30">
            <div class="text-[9px] text-orange-500 font-bold">共振連動</div>
            <div class="text-lg font-black text-white" id="p2">--</div>
        </div>
        <div class="bg-white/5 p-2 rounded-lg text-center border border-white/5">
            <div class="text-[9px] text-gray-400 font-bold">動態對沖</div>
            <div class="text-lg font-black text-white" id="p3">--</div>
        </div>
        <div class="bg-white/5 p-2 rounded-lg text-center border border-white/5">
            <div class="text-[9px] text-gray-400 font-bold">結構補位</div>
            <div class="text-lg font-black text-white" id="p4">--</div>
        </div>
    </div>
</div>

<div class="ios-panel p-4 flex-grow overflow-hidden flex flex-col">
    <label class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mb-2">聚變測試：將 1 星轉化為多星</label>
    <div class="overflow-y-auto flex-grow">
        <table class="w-full text-[12px]">
            <thead class="sticky top-0 bg-[#1c1c1e] text-gray-500">
                <tr class="text-left border-b border-white/10">
                    <th class="pb-2">日期</th>
                    <th class="pb-2">開獎</th>
                    <th class="pb-2">狙擊選碼</th>
                    <th class="pb-2 text-right">星</th>
                </tr>
            </thead>
            <tbody id="historyTable" class="divide-y divide-white/5"></tbody>
        </table>
    </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbys9LFrmqnTftrPqTprRhfn6YBsMH63K4BKOfZfbM7m1wAP_CxH6v9M_2RpIGtbW9cIeA/exec";
let currentMode = '539';
let fullData = [];

document.addEventListener('DOMContentLoaded', () => {
    fetchData();
    document.getElementById('btn539').addEventListener('click', () => switchMode('539'));
    document.getElementById('btnDaily').addEventListener('click', () => switchMode('Daily'));
});

async function fetchData() {
    const log = document.getElementById('logBox');
    try {
        const response = await fetch(API_URL);
        const text = await response.text();
        try {
            fullData = JSON.parse(text);
            processData(fullData);
        } catch(e) {
            log.innerText = "JSON 解析錯誤: " + text;
        }
    } catch (error) {
        log.innerText = "API 連線錯誤: " + error.message;
    }
}

function switchMode(mode) {
    currentMode = mode;
    document.getElementById('btn539').className = `px-4 py-1.5 rounded-lg text-sm transition-all ${mode==='539'?'btn-active':'btn-inactive'} whitespace-nowrap`;
    document.getElementById('btnDaily').className = `px-4 py-1.5 rounded-lg text-sm transition-all ${mode==='Daily'?'btn-active ml-1':'btn-inactive ml-1'} whitespace-nowrap`;
    if(fullData.length > 0) processData(fullData);
}

function getFusionPrediction(history) {
    const range = currentMode === '539' ? 39 : 36;
    const lastNums = history[0].nums;
    const prevNums = history[1]?.nums || [];
    let shortCounts = Array(range + 1).fill(0);
    history.slice(0, 8).forEach(r => r.nums.forEach(n => shortCounts[n]++));
    let longCounts = Array(range + 1).fill(0);
    history.slice(0, 35).forEach(r => r.nums.forEach(n => longCounts[n]++));
    let gaps = Array(range + 1).fill(0);
    for(let n=1; n<=range; n++){
        let g=0;
        for(let r of history){ if(r.nums.includes(n)) break; g++; }
        gaps[n] = g;
    }

    let scores=[];
    for(let n=1;n<=range;n++){
        let baseHeat=(shortCounts[n]*2.5)+(longCounts[n]*0.3);
        let isNeighbor=lastNums.some(ln=>Math.abs(ln-n)===1);
        let isRepeat=lastNums.includes(n);
        let penalty=(lastNums.includes(n)&&prevNums.includes(n))?0.7:1.0;
        let gapBonus=(gaps[n]>=2&&gaps[n]<=7)?2.2:1.0;
        let hedgeScore=(gaps[n]>=14)?2.5:0;
        scores.push({n:n,val:((baseHeat*(isNeighbor?1.6:1)*(isRepeat?1.4:1)*gapBonus)+(5/(gaps[n]+1))+hedgeScore)*penalty,gap:gaps[n],tail:n%10});
    }
    scores.sort((a,b)=>b.val-a.val);

    let picked=new Set();
    scores.slice(0,3).forEach(s=>picked.add(s.n));
    let coreArray=Array.from(picked);
    let candidates=scores.filter(s=>!picked.has(s.n));
    for(let s of candidates){
        if(picked.size>=6) break;
        if(coreArray.some(cn=>Math.abs(cn-s.n)===1||cn%10===s.n%10)) picked.add(s.n);
    }
    candidates=scores.filter(s=>!picked.has(s.n));
    candidates.sort((a,b)=>b.gap-a.gap);
    if(candidates.length>0) picked.add(candidates[0].n);
    candidates.sort((a,b)=>b.val-a.val);
    for(let s of candidates){ if(picked.size>=8) break; picked.add(s.n); }

    const pred=Array.from(picked).sort((a,b)=>a-b).map(x=>x.toString().padStart(2,'0'));
    const sIndex=(scores[0].val*1.48).toFixed(2);
    return {pred,sIndex};
}

function processData(data){
    let history=data.filter(row=>row.length>=6).map(row=>({date:String(row[0]).split('T')[0],nums:row.slice(1,6).map(n=>parseInt(n)).filter(n=>!isNaN(n)).sort((a,b)=>a-b)})).filter(h=>h.nums.length===5);
    if(new Date(history[0].date)<new Date(history[history.length-1].date)) history.reverse();

    let stars=0,rowsHtml="",lastS=0;
    for(let i=0;i<10;i++){
        const result=getFusionPrediction(history.slice(i+1));
        const actual=history[i].nums;
        const hits=actual.filter(n=>result.pred.includes(n.toString().padStart(2,'0'))).length;
        stars+=hits;
        if(i===0) lastS=result.sIndex;
        const predHtml=result.pred.map(p=>actual.includes(parseInt(p))?`<span class="hit-num">${p}</span>`:p).join(',');
        rowsHtml+=`<tr class="border-b border-white/5"><td class="py-3 text-gray-500">${history[i].date.split('-').slice(1).join('/')}</td><td class="font-mono text-white">${actual.map(n=>n.toString().padStart(2,'0')).join(' ')}</td><td class="text-[11px] text-gray-400 font-mono">${predHtml}</td><td class="text-right font-black ${hits>=2?'text-orange-500':'text-gray-700'}">${hits}</td></tr>`;
    }
    document.getElementById('historyTable').innerHTML=rowsHtml;

    // 自動填充 Panel 3 8 碼
    const latestPred = getFusionPrediction(history).pred;
    document.getElementById('p1').innerText = latestPred.slice(0,2).join(' ');
    document.getElementById('p2').innerText = latestPred.slice(2,4).join(' ');
    document.getElementById('p3').innerText = latestPred.slice(4,6).join(' ');
    document.getElementById('p4').innerText = latestPred.slice(6,8).join(' ');

    document.getElementById('logBox').innerHTML=`近十期平均星數: ${(stars/10).toFixed(2)} | 最新指數: ${lastS}`;
}
</script>
</body>
</html>
