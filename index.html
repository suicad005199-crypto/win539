<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>demo面板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* iOS 禁止縮放與選取優化 */
        body { -webkit-tap-highlight-color: transparent; user-select: none; background-color: #000; }
        .num-btn { @apply w-full aspect-square flex items-center justify-center rounded-full border border-gray-800 font-bold text-lg transition-all active:scale-90 bg-zinc-900 text-gray-300; }
        .num-btn.selected { @apply bg-orange-500 border-orange-400 text-white shadow-[0_0_15px_rgba(249,115,22,0.5)]; }
        .ios-blur { backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="text-white pb-32">

    <div class="sticky top-0 z-50 bg-black/80 ios-blur border-b border-zinc-800 px-4 py-4">
        <div class="flex justify-between items-end">
            <div>
                <h1 class="text-2xl font-black text-orange-500 tracking-tighter">539 STRATEGY</h1>
                <p id="current-label" class="text-[10px] text-zinc-500 font-bold uppercase">今彩 539 / 數據同步中</p>
            </div>
            <button onclick="fetchData()" class="bg-zinc-800 p-2 rounded-full active:bg-zinc-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
            </button>
        </div>
    </div>

    <div class="p-4 space-y-6">
        
        <div class="bg-zinc-900 p-1 rounded-xl flex border border-zinc-800">
            <button onclick="switchSource('539')" id="tab-539" class="flex-1 py-2 text-sm rounded-lg font-bold transition-all bg-orange-500 text-white">今彩 539</button>
            <button onclick="switchSource('fantasy5')" id="tab-fantasy5" class="flex-1 py-2 text-sm rounded-lg font-bold transition-all text-zinc-500">天天樂</button>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <div class="bg-zinc-900/50 border border-zinc-800 p-4 rounded-2xl">
                <p class="text-zinc-500 text-[10px] font-bold mb-2 uppercase">熱門尾數</p>
                <div id="hot-tails" class="flex gap-2">
                    <span class="text-orange-500 font-black text-xl">--</span>
                </div>
            </div>
            <div class="bg-zinc-900/50 border border-zinc-800 p-4 rounded-2xl">
                <p class="text-zinc-500 text-[10px] font-bold mb-2 uppercase">大號佔比</p>
                <div class="flex items-end gap-2">
                    <span id="size-ratio" class="text-white font-black text-xl">0%</span>
                    <div class="flex-1 bg-zinc-800 h-1.5 rounded-full mb-1.5 overflow-hidden">
                        <div id="size-bar" class="bg-orange-500 h-full transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-zinc-900/30 rounded-3xl p-4 border border-zinc-800">
            <div class="flex justify-between items-center mb-4 px-2">
                <span class="text-xs font-bold text-zinc-400">智能選號盤 (01-39)</span>
                <button onclick="clearSelection()" class="text-xs text-orange-500/50">RESET</button>
            </div>
            <div class="grid grid-cols-5 gap-3" id="number-grid">
                </div>
        </div>

        <div class="bg-orange-500/10 border border-orange-500/20 p-4 rounded-2xl">
            <p id="strategy-tip" class="text-orange-200 text-xs leading-relaxed text-center font-medium">
                點擊上方刷新按鈕，獲取最新戰略建議。
            </p>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 bg-black/90 ios-blur border-t border-zinc-800 px-6 pt-4 safe-area-bottom">
        <div class="flex justify-between items-center mb-4">
            <div class="flex gap-4">
                <div class="text-center">
                    <p class="text-[10px] text-zinc-500 uppercase">2星注</p>
                    <p id="star2-count" class="text-lg font-mono font-bold text-orange-500">0</p>
                </div>
                <div class="text-center">
                    <p class="text-[10px] text-zinc-500 uppercase">3星注</p>
                    <p id="star3-count" class="text-lg font-mono font-bold text-white">0</p>
                </div>
            </div>
            <div class="text-right">
                <p class="text-[10px] text-zinc-500 uppercase">已選號碼</p>
                <p id="selected-count" class="text-lg font-mono font-bold text-white">0</p>
            </div>
        </div>
        <button onclick="window.scrollTo({top:0, behavior:'smooth'})" class="w-full bg-orange-500 text-black font-black py-4 rounded-2xl active:bg-orange-600 transition-all mb-4">
            確認戰略組合
        </button>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxX4EPXapWEH0l7yodiQjAquQQMNq73WkChSIuWnsd3_p59grPf9AKsrN32TtMXydBa-A/exec';
        let currentSource = '539';
        let selectedNumbers = [];

        function initGrid() {
            const grid = document.getElementById('number-grid');
            grid.innerHTML = '';
            for (let i = 1; i <= 39; i++) {
                const num = i.toString().padStart(2, '0');
                const btn = document.createElement('button');
                btn.className = 'num-btn';
                btn.innerText = num;
                btn.onclick = () => {
                    btn.classList.toggle('selected');
                    if (selectedNumbers.includes(num)) {
                        selectedNumbers = selectedNumbers.filter(n => n !== num);
                    } else {
                        selectedNumbers.push(num);
                    }
                    updateCalc();
                };
                grid.appendChild(btn);
            }
        }

        function switchSource(type) {
            currentSource = type;
            const is539 = type === '539';
            document.getElementById('tab-539').className = `flex-1 py-2 text-sm rounded-lg font-bold transition-all ${is539 ? 'bg-orange-500 text-white' : 'text-zinc-500'}`;
            document.getElementById('tab-fantasy5').className = `flex-1 py-2 text-sm rounded-lg font-bold transition-all ${!is539 ? 'bg-orange-500 text-white' : 'text-zinc-500'}`;
            document.getElementById('current-label').innerText = is539 ? '今彩 539 / 數據讀取中' : '天天樂 / 數據讀取中';
            clearSelection();
            fetchData();
        }

        function updateCalc() {
            const n = selectedNumbers.length;
            document.getElementById('selected-count').innerText = n;
            document.getElementById('star2-count').innerText = n < 2 ? 0 : (n * (n - 1) / 2);
            document.getElementById('star3-count').innerText = n < 3 ? 0 : (n * (n - 1) * (n - 2) / 6);
        }

        function clearSelection() {
            selectedNumbers = [];
            document.querySelectorAll('.num-btn').forEach(b => b.classList.remove('selected'));
            updateCalc();
        }

        async function fetchData() {
            try {
                const response = await fetch(`${API_URL}?sheet=${currentSource}`);
                const data = await response.json();
                analyzeData(data);
            } catch (e) {
                document.getElementById('strategy-tip').innerText = "API 連線失敗，請檢查網路。";
            }
        }

        function analyzeData(data) {
            const tails = {};
            let bigCount = 0;
            let totalBalls = 0;

            data.forEach(row => {
                const nums = [row.num1, row.num2, row.num3, row.num4, row.num5];
                nums.forEach(n => {
                    const val = parseInt(n);
                    if (!isNaN(val)) {
                        const tail = val % 10;
                        tails[tail] = (tails[tail] || 0) + 1;
                        if (val >= 20) bigCount++;
                        totalBalls++;
                    }
                });
            });

            const sortedTails = Object.entries(tails).sort((a,b)=>b[1]-a[1]).slice(0,3);
            document.getElementById('hot-tails').innerHTML = sortedTails.map(t=>`<span class="text-orange-500 font-black text-xl">${t[0]}</span>`).join('<span class="text-zinc-700">/</span>');
            
            const bigRatio = ((bigCount / totalBalls) * 100).toFixed(0);
            document.getElementById('size-ratio').innerText = bigRatio + '%';
            document.getElementById('size-bar').style.width = bigRatio + '%';

            document.getElementById('strategy-tip').innerText = `近期 ${sortedTails[0][0]} 尾強勢，大號比例為 ${bigRatio}%，建議專攻 2 星組合。`;
        }

        initGrid();
    </script>
</body>
</html>
