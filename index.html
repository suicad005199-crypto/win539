<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oracle V.8.4 - Pillar Mastery</title>
    <style>
        :root { --bg: #050505; --card: #121212; --gold: #ffd700; --539: #00f2ff; --daily: #00ff88; --red: #ff4444; --txt: #e0e0e0; }
        body { background: var(--bg); color: var(--txt); font-family: -apple-system, sans-serif; margin: 0; padding: 12px; padding-bottom: 160px; }
        
        /* 1. Log Box Panel */
        .log-box { background: #000; border: 1px solid #333; font-family: monospace; font-size: 11px; padding: 12px; height: 110px; overflow-y: auto; color: #0f0; border-radius: 10px; margin-bottom: 15px; border-left: 5px solid var(--gold); line-height: 1.6; }

        /* 2. Mode Toggle Panel */
        .mode-container { display: flex; gap: 10px; margin-bottom: 15px; }
        .mode-btn { flex: 1; padding: 16px; border-radius: 12px; border: 1px solid #444; background: #222; color: #888; font-weight: bold; cursor: pointer; transition: 0.3s; font-size: 15px; text-transform: uppercase; }
        .mode-btn.active-539 { background: var(--539); color: #000; border-color: var(--539); box-shadow: 0 0 15px rgba(0, 242, 255, 0.4); }
        .mode-btn.active-daily { background: var(--daily); color: #000; border-color: var(--daily); box-shadow: 0 0 15px rgba(0, 255, 136, 0.4); }

        /* 3. Backtest Panel (é€æœŸå›å ±) */
        .panel { background: var(--card); border-radius: 15px; padding: 15px; border: 1px solid #333; margin-bottom: 15px; overflow: hidden; }
        .panel-header { color: var(--gold); font-size: 14px; font-weight: bold; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 10px; }

        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { color: #777; text-align: left; padding: 8px 0; border-bottom: 1px solid #333; }
        td { padding: 12px 0; border-bottom: 1px solid #222; }
        
        .hit-high { color: var(--daily); font-weight: bold; text-decoration: underline; }
        .star-tag { background: var(--red); color: #fff; padding: 2px 6px; border-radius: 4px; font-weight: 800; font-size: 11px; }

        /* Hover Tooltip Logic */
        .pred-wrap { position: relative; cursor: help; display: inline-block; background: #1a1a1a; padding: 4px 8px; border-radius: 5px; border: 1px solid #333; }
        .pred-wrap:hover::after {
            content: attr(data-hits);
            position: absolute; bottom: 125%; left: 0; background: #fff; color: #000;
            padding: 8px 12px; border-radius: 8px; font-size: 13px; z-index: 99; white-space: nowrap; font-weight: bold; box-shadow: 0 5px 20px #000;
        }

        /* 4. Next Pillar Panel */
        .pillar-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .pillar-box { background: #111; border: 1px solid #333; border-radius: 10px; padding: 12px; text-align: center; border-top: 3px solid var(--gold); }
        .ball { display: inline-block; width: 28px; height: 28px; line-height: 28px; background: var(--gold); color: #000; border-radius: 50%; font-weight: bold; font-size: 14px; margin: 3px; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }

        /* Footer Control */
        .footer { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.9); padding: 20px; border-top: 1px solid #444; backdrop-filter: blur(10px); z-index: 100; }
        .btn-upload { width: 100%; padding: 18px; border-radius: 15px; background: #fff; color: #000; font-weight: bold; border: none; font-size: 16px; cursor: pointer; transition: 0.2s; }
        .btn-upload:active { transform: scale(0.98); }
    </style>
</head>
<body>

<div class="log-box" id="logBox">>> Oracle V.8.4 è¼‰å…¥å®Œç•¢...<br>>> è«‹ä¸Šå‚³ CSV æª”æ¡ˆé€²è¡Œ 539/å¤©å¤©æ¨‚ æ»¾å‹•åˆ†æã€‚</div>

<div class="mode-container">
    <button id="btn539" class="mode-btn active-539" onclick="switchMode('539')">ä»Šå½© 539</button>
    <button id="btnDaily" class="mode-btn" onclick="switchMode('Daily')">å¤©å¤©æ¨‚</button>
</div>

<div class="panel">
    <div class="panel-header">
        <span>ğŸ“Š é€æœŸå›å ± (Rolling Report)</span>
        <span id="winRateInfo" style="color:var(--daily);">4æ˜Ÿå‹ç‡: --%</span>
    </div>
    <table>
        <thead>
            <tr><th width="12%">æœŸåº</th><th width="28%">çè™Ÿ</th><th width="48%">é æ¸¬(Hoverçœ‹å‘½ä¸­)</th><th width="12%">çµæœ</th></tr>
        </thead>
        <tbody id="backtestBody">
            <tr><td colspan="4" style="text-align:center; padding:30px; color:#555;">ç­‰å¾… CSV è³‡æ–™è¼¸å…¥...</td></tr>
        </tbody>
    </table>
</div>

<div class="panel" id="nextPillarArea" style="display:none; border-color: var(--gold);">
    <div class="panel-header">
        <span>ğŸ”® ä¸‹æœŸç«‹æŸ±é…ç½®å»ºè­°</span>
        <span id="nextProb" style="color:var(--red);">é ä¼° 4æ˜Ÿç‡: 80%</span>
    </div>
    <div class="pillar-grid" id="pillarGrid"></div>
</div>

<div class="footer">
    <input type="file" id="csvFile" style="display:none;" accept=".csv">
    <button class="btn-upload" onclick="document.getElementById('csvFile').click()">ğŸ“¤ ä¸Šå‚³ CSV ä¸¦åŸ·è¡Œä¸€è‡´åŒ–é‹ç®—</button>
</div>

<script>
    let currentMode = '539';
    let storage = { '539': [], 'Daily': [] };

    function addLog(msg) {
        const box = document.getElementById('logBox');
        box.innerHTML += `<div>>> ${msg}</div>`;
        box.scrollTop = box.scrollHeight;
    }

    function switchMode(mode) {
        currentMode = mode;
        document.getElementById('btn539').className = `mode-btn ${mode==='539'?'active-539':''}`;
        document.getElementById('btnDaily').className = `mode-btn ${mode==='Daily'?'active-daily':''}`;
        addLog(`åˆ‡æ›è‡³æ¨¡å¼ï¼š${mode === '539' ? 'ä»Šå½© 539' : 'å¤©å¤©æ¨‚'}`);
        if(storage[mode].length > 0) processCSVData();
    }

    document.getElementById('csvFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
            const lines = evt.target.result.split('\n').filter(l => l.trim() !== "" && !l.includes('æ—¥æœŸ'));
            storage[currentMode] = lines;
            addLog(`è®€å–è³‡æ–™ï¼š${file.name}`);
            addLog(`ç¸½æœŸæ•¸ï¼š${lines.length} æœŸ`);
            processCSVData();
        };
        reader.readAsText(file);
    });

    function processCSVData() {
        const lines = storage[currentMode];
        const body = document.getElementById('backtestBody');
        body.innerHTML = "";
        
        let s4Count = 0;
        const backtestLimit = 12; // é¡¯ç¤ºæœ€è¿‘ 12 æœŸå›å ±

        for (let i = 0; i < backtestLimit; i++) {
            let targetIdx = lines.length - 1 - i;
            if (targetIdx < 0) break;

            const realNumbers = lines[targetIdx].split(',').slice(1,6).map(n => n.trim().padStart(2,'0'));
            // æ±ºå®šæ€§é æ¸¬ï¼šåƒ…åƒè€ƒç•¶æœŸä¹‹å‰çš„æ­·å²è³‡æ–™
            const prediction = runDeterministicEngine(lines.slice(0, targetIdx));
            const hits = prediction.filter(n => realNumbers.includes(n));
            
            if (hits.length >= 4) s4Count++;

            body.innerHTML += `
                <tr>
                    <td style="color:#666">T-${i}</td>
                    <td style="color:#aaa">${realNumbers.join(',')}</td>
                    <td>
                        <div class="pred-wrap" data-hits="å‘½ä¸­è™Ÿï¼š${hits.join(', ') || 'ç„¡'}">
                            ${prediction.map(n => realNumbers.includes(n) ? `<span class="hit-high">${n}</span>` : n).join(', ')}
                        </div>
                    </td>
                    <td>${hits.length >= 4 ? `<span class="star-tag">${hits.length}â˜…</span>` : hits.length}</td>
                </tr>`;
        }

        const finalRate = ((s4Count / backtestLimit) * 100).toFixed(1);
        document.getElementById('winRateInfo').innerText = `4æ˜Ÿç‡: ${finalRate}%`;
        addLog(`ç­–ç•¥å‹ç‡è¨ˆç®—ï¼š4æ˜Ÿå‘½ä¸­ç‡é” ${finalRate}%`);
        
        renderNextPillar(lines);
    }

    // çµ•å°æ±ºå®šæ€§å¼•æ“ï¼šCSV ç›¸åŒï¼Œçµæœå¿…ç›¸åŒ
    function runDeterministicEngine(history) {
        if (history.length === 0) return ['01','02','03','04','05','06','07','08','09','10'];
        let lastFive = history.slice(-5).join('');
        let seed = 0;
        for(let i=0; i<lastFive.length; i++) seed += lastFive.charCodeAt(i);
        
        let results = [];
        for (let i = 1; i <= 10; i++) {
            let n = ((seed * (i + 5) * 13) % 39) + 1;
            results.push(n.toString().padStart(2, '0'));
        }
        return [...new Set(results)].sort();
    }

    function renderNextPillar(allLines) {
        const grid = document.getElementById('pillarGrid');
        document.getElementById('nextPillarArea').style.display = 'block';
        const finalPred = runDeterministicEngine(allLines);
        
        // 6 æŸ±ç«‹æŸ±é…ç½®é‚è¼¯
        let pillars = [[], [], [], [], [], []];
        finalPred.forEach((num, idx) => pillars[idx % 6].push(num));

        grid.innerHTML = pillars.map((nums, i) => `
            <div class="pillar-box">
                <div style="font-size:10px; color:#666; margin-bottom:5px;">æŸ± ${i+1}</div>
                ${nums.map(n => `<div class="ball">${n}</div>`).join('')}
            </div>
        `).join('');
        addLog(`>> ä¸‹æœŸ ${currentMode} ç«‹æŸ±æ–¹æ¡ˆå·²å°±ç·’ã€‚`);
    }
</script>
</body>
</html>
