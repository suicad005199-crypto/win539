<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root { --ios-blue: #007AFF; --ios-red: #FF3B30; --ios-green: #4CD964; --ios-gold: #FFD700; }
        body { margin: 0; background: #1c1c1e; color: white; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; padding-top: 15px; }
        
        /* ç‹€æ…‹åˆ— */
        #header { width: 90vw; max-width: 400px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .hp-box { width: 150px; }
        .hp-bar-bg { width: 100%; height: 10px; background: #3a3a3c; border-radius: 5px; overflow: hidden; margin-top: 4px; }
        #hp-bar { width: 100%; height: 100%; background: var(--ios-green); transition: width 0.3s; }
        
        /* ç¶²æ ¼ */
        .grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; width: 95vw; max-width: 400px; background: #2c2c2e; padding: 6px; border-radius: 12px; }
        .cell { aspect-ratio: 1; background: #444; border-radius: 4px; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; }
        .player { background: var(--ios-blue) !important; box-shadow: 0 0 10px var(--ios-blue); }
        .reachable { outline: 2px solid var(--ios-green); outline-offset: -2px; }

        /* Slot å‹•ç•«å„ªåŒ– */
        #slot-machine { margin-top: 20px; width: 280px; background: #2c2c2e; padding: 15px; border-radius: 20px; border: 2px solid var(--ios-gold); text-align: center; }
        .slot-container { display: flex; justify-content: space-between; margin: 10px 0; }
        .slot-box { 
            width: 70px; height: 70px; background: #1c1c1e; border-radius: 8px; 
            font-size: 2rem; display: flex; align-items: center; justify-content: center;
            overflow: hidden; position: relative;
        }
        .spinning { animation: roll 0.1s linear infinite; }
        @keyframes roll {
            0% { transform: translateY(-10px); opacity: 0.5; }
            100% { transform: translateY(10px); opacity: 1; }
        }

        .spin-btn { 
            background: var(--ios-gold); color: #000; border: none; width: 100%; padding: 10px; 
            border-radius: 25px; font-weight: bold; font-size: 1rem; opacity: 0.3; pointer-events: none; 
        }
        .spin-active { opacity: 1; pointer-events: auto; }
    </style>
</head>
<body>

<div id="header">
    <div class="hp-box">
        <span style="font-size: 12px; font-weight: bold;">HP <span id="hp-txt">100</span></span>
        <div class="hp-bar-bg"><div id="hp-bar"></div></div>
    </div>
    <div style="text-align: right; font-weight: bold;">
        <span style="color:var(--ios-gold)">ATK: <span id="atk">10</span></span>
    </div>
</div>

<div class="grid" id="grid"></div>

<div id="slot-machine">
    <div class="slot-container">
        <div class="slot-box" id="s1">â“</div>
        <div class="slot-box" id="s2">â“</div>
        <div class="slot-box" id="s3">â“</div>
    </div>
    <button id="spin-btn" class="spin-btn" onclick="startSpin()">SPIN (0)</button>
</div>

<script>
    const skills = ['ğŸ', 'âš”ï¸', 'ğŸ’£', 'ğŸ›¡ï¸'];
    const stats = { hp: 100, maxHp: 100, atk: 10, spins: 0, shield: false };
    let playerPos = 0;
    let mapData = [];
    let isSpinning = false;

    function init() {
        const types = ['B', 'P', ...Array(8).fill('H'), ...Array(8).fill('S'), ...Array(46).fill('M')];
        mapData = types.sort(() => Math.random() - 0.5);
        playerPos = mapData.indexOf('P');
        render();
    }

    function render() {
        gridEl = document.getElementById('grid');
        gridEl.innerHTML = '';
        mapData.forEach((type, i) => {
            const cell = document.createElement('div');
            const dist = getDist(playerPos, i);
            cell.className = `cell ${i === playerPos ? 'player' : ''} ${dist === 1 ? 'reachable' : ''}`;
            if (i === playerPos) cell.innerHTML = 'ğŸ‘¤';
            else if (type === 'M') cell.innerHTML = 'ğŸ‘¾';
            else if (type === 'B') cell.innerHTML = 'ğŸ‘¹';
            else if (type === 'H') cell.innerHTML = 'â¤ï¸';
            else if (type === 'S') cell.innerHTML = 'âš¡';
            cell.onclick = () => move(i);
            gridEl.appendChild(cell);
        });
        updateUI();
    }

    function move(target) {
        if (getDist(playerPos, target) !== 1 || isSpinning) return;
        const type = mapData[target];

        if (type === 'M' || type === 'B') {
            if (!stats.shield) {
                stats.hp -= type === 'B' ? 50 : 15;
            } else {
                alert("è­·ç›¾æŠµæ“‹äº†å‚·å®³ï¼");
                stats.shield = false;
            }
            if (Math.random() < 0.4) stats.spins++; 
        } else if (type === 'H') stats.hp = Math.min(stats.maxHp, stats.hp + 20);
        else if (type === 'S') stats.atk += 5;

        if (stats.hp <= 0) { alert("æˆ°æ•—ï¼"); location.reload(); return; }
        mapData[playerPos] = 'E';
        playerPos = target;
        mapData[playerPos] = 'P';
        render();
    }

    function startSpin() {
        if (stats.spins <= 0 || isSpinning) return;
        isSpinning = true;
        stats.spins--;
        updateUI();

        const boxes = [document.getElementById('s1'), document.getElementById('s2'), document.getElementById('s3')];
        boxes.forEach(b => b.classList.add('spinning'));

        // æ¨¡æ“¬æ»¾å‹•åœæ­¢æ™‚é–“
        boxes.forEach((box, i) => {
            setTimeout(() => {
                box.classList.remove('spinning');
                box.innerText = skills[Math.floor(Math.random() * skills.length)];
                if (i === 2) checkWin(boxes.map(b => b.innerText));
            }, 800 + (i * 400));
        });
    }

    function checkWin(res) {
        isSpinning = false;
        if (res[0] === res[1] && res[1] === res[2]) {
            const win = res[0];
            if (win === 'ğŸ') { stats.maxHp += 50; stats.hp = stats.maxHp; alert("ã€ç”Ÿå‘½æ³‰æºã€‘HPä¸Šé™å¢åŠ ä¸¦è£œæ»¿ï¼"); }
            if (win === 'âš”ï¸') { stats.atk += 20; alert("ã€ç‹‚æˆ°å£«ã€‘æ”»æ“ŠåŠ›å¤§å¹…æå‡ï¼"); }
            if (win === 'ğŸ’£') { 
                alert("ã€æ ¸çˆ†ã€‘éš¨æ©Ÿæ¸…é™¤åœ°åœ–ä¸Šçš„ 5 éš»æ€ªç‰©ï¼");
                for(let i=0; i<5; i++) {
                    let idx = mapData.indexOf('M');
                    if(idx !== -1) mapData[idx] = 'E';
                }
                render();
            }
            if (win === 'ğŸ›¡ï¸') { stats.shield = true; alert("ã€ç¥è–è­·ç›¾ã€‘ä¸‹æ¬¡æˆ°é¬¥å…å‚·ï¼"); }
        } else {
            alert("å¾ˆå¯æƒœï¼Œæ²’æœ‰é€£ç·šã€‚");
        }
        updateUI();
    }

    function getDist(p1, p2) {
        const x1 = p1 % 8, y1 = Math.floor(p1 / 8);
        const x2 = p2 % 8, y2 = Math.floor(p2 / 8);
        return Math.abs(x1 - x2) + Math.abs(y1 - y2);
    }

    function updateUI() {
        document.getElementById('hp-bar').style.width = `${(stats.hp / stats.maxHp) * 100}%`;
        document.getElementById('hp-txt').innerText = stats.hp;
        document.getElementById('atk').innerText = stats.atk;
        const btn = document.getElementById('spin-btn');
        btn.innerText = `SPIN (${stats.spins})`;
        btn.className = (stats.spins > 0 && !isSpinning) ? 'spin-btn spin-active' : 'spin-btn';
    }

    init();
</script>
</body>
</html>
