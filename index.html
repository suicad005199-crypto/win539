<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>539 ç²¾æº–åˆ†æ V.42.3 - 6ç¢¼å›æ¸¬ç‰ˆ</title>
    <style>
        :root { --bg: #000; --panel: #1c1c1e; --primary: #ffd60a; --border: #38383a; --text: #fff; --sub: #8e8e93; --hit: #ff375f; --accent: #0a84ff; --success: #32d74b; }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; font-size: 13px; }
        .container { display: flex; flex-direction: column; gap: 12px; }
        .panel { background: var(--panel); border-radius: 12px; padding: 12px; border: 1px solid var(--border); }
        .panel-header { color: var(--primary); font-weight: bold; margin-bottom: 10px; border-left: 3px solid var(--primary); padding-left: 8px; font-size: 14px; }
        
        /* P2 æ¨£å¼ */
        .bt-row { border-bottom: 1px solid var(--border); padding: 10px 0; display: flex; flex-direction: column; gap: 6px; }
        .bt-meta { display: flex; justify-content: space-between; color: var(--sub); font-size: 11px; }
        .num-group { display: flex; gap: 4px; align-items: center; }
        .num-label { font-size: 10px; color: var(--sub); width: 30px; flex-shrink: 0; }
        .n-box { width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; border-radius: 4px; background: #2c2c2e; font-size: 11px; font-weight: bold; }
        .n-box.hit { background: var(--primary); color: #000; box-shadow: 0 0 5px var(--primary); }
        .star-tag { background: var(--success); color: #000; padding: 2px 8px; border-radius: 4px; font-weight: 900; }

        .matrix-scroll { overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; }
        .m-table { border-collapse: collapse; white-space: nowrap; }
        .m-table td, .m-table th { border: 1px solid #333; width: 18px; height: 18px; text-align: center; font-size: 9px; }
        .m-head { background: #2c2c2e; color: var(--primary); position: sticky; top: 0; }
        .m-date { background: #2c2c2e; color: var(--sub); position: sticky; left: 0; width: 50px; z-index: 5; }
        .m-ball { background: var(--hit); border-radius: 50%; width: 12px; height: 12px; display: inline-block; }
        
        #logBox { background: #000; color: var(--success); padding: 10px; height: 100px; overflow-y: auto; font-family: monospace; font-size: 11px; border: 1px solid var(--border); line-height: 1.5; }
        .ball-row { display: flex; flex-wrap: wrap; gap: 6px; }
        .ball { width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; background: #2c2c2e; border-radius: 50%; font-weight: bold; border: 2px solid var(--accent); color: var(--accent); font-size: 16px; }
    </style>
</head>
<body>
<div class="container">
    <div class="panel">
        <div class="panel-header">P1: æ•¸æ“šæ³¨å…¥ (6ç¢¼ç©©å®šç‰ˆ)</div>
        <input type="file" id="csvFile" accept=".csv">
    </div>
    
    <div class="panel">
        <div class="panel-header">P2: é€æœŸå›æ¸¬ (æœ€è¿‘ 10 æœŸ)</div>
        <div id="btBody"></div>
    </div>

    <div class="panel">
        <div class="panel-header">P3: ä¸‹æœŸçµæ§‹é æ¸¬ (ç²¾é¸ 6 ç¢¼)</div>
        <div id="nextPred" class="ball-row"></div>
    </div>

    <div class="panel">
        <div class="panel-header">P4: åˆ†å¸ƒçŸ©é™£</div>
        <div class="matrix-scroll" id="matrixCont"></div>
    </div>

    <div class="panel">
        <div id="logBox">ç­‰å¾… CSV åŒ¯å…¥...</div>
    </div>
</div>

<script>
    // 4ï¸âƒ£ åƒæ•¸æ¨¡çµ„åŒ–
    const CONFIG = {
        weights: {
            gapShort: 3.0,     // çŸ­æ¼ç¢¼æ¬Šé‡
            tailFreq: 3.2,     // å°¾æ•¸ç†±åº¦æ¬Šé‡
            neighbor: 20,      // é„°è™Ÿæ¬Šé‡
            reentry: 15        // é‡è™Ÿæ¬Šé‡
        },
        constraints: {
            maxSameTail: 2,    // åŒå°¾æœ€å¤š 2 ç¢¼
            maxConsecutive: 2, // é€£è™Ÿæœ€å¤š 2 ç¢¼
            maxPerZone: 3      // å–®ä¸€å€æ®µ (1-13, 14-26, 27-39) æœ€å¤š 3 ç¢¼
        }
    };

    let rawData = [];
    const log = (m) => { const b = document.getElementById('logBox'); b.innerHTML += `> ${m}<br>`; b.scrollTop = b.scrollHeight; };
    const pad = (n) => n.toString().padStart(2, '0');
    const formatDate = (s) => { const p = s.split(/[-/]/); return p.length >= 3 ? `${p[1]}/${p[2]}` : s; };

    // æ ¸å¿ƒé æ¸¬é‚è¼¯
    function getV423Prediction(hist) {
        if (hist.length < 20) return [1, 2, 3, 4, 5, 6];

        let stats = Array(40).fill(0).map((_, i) => ({ n: i, score: 0 }));
        const lastRow = hist[hist.length - 1].nums;

        // 1. æ¼ç¢¼åˆ†æ
        for (let i = 1; i <= 39; i++) {
            let gap = 0;
            for (let k = hist.length - 1; k >= 0; k--) {
                if (!hist[k].nums.includes(i)) gap++; else break;
            }
            stats[i].score += (gap <= 12) ? (gap * CONFIG.weights.gapShort) : Math.max(0, 38 - gap);
        }

        // 2. å°¾æ•¸åˆ†æ (æœ€è¿‘ 15 æœŸ)
        let tailMap = Array(10).fill(0);
        hist.slice(-15).forEach(d => d.nums.forEach(n => tailMap[n % 10]++));
        for (let i = 1; i <= 39; i++) stats[i].score += (tailMap[i % 10] * CONFIG.weights.tailFreq);

        // 3. é„°è™Ÿèˆ‡é‡è™Ÿ
        lastRow.forEach(ln => {
            if (ln > 1) stats[ln - 1].score += CONFIG.weights.neighbor;
            if (ln < 39) stats[ln + 1].score += CONFIG.weights.neighbor;
            stats[ln].score += CONFIG.weights.reentry;
        });

        // 4. åˆé¸å‰ 12 ç¢¼ (æ“´å¤§æ± å­é€²è¡Œçµæ§‹ç¯©é¸)
        let candidates = stats.slice(1).sort((a, b) => b.score - a.score).slice(0, 12);
        
        // 5. äºŒæ¬¡ç¯©é¸ (çµæ§‹ç´„æŸ)
        let finalSix = [];
        let tailCount = {};
        let zoneCount = [0, 0, 0];

        for (let cand of candidates) {
            if (finalSix.length >= 6) break;

            const t = cand.n % 10;
            const z = Math.min(Math.floor((cand.n - 1) / 13), 2);
            
            // æª¢æŸ¥é€£è™Ÿ (é¿å…ä¸‰é€£è™Ÿ)
            const hasTooManyConsecutive = finalSix.filter(n => Math.abs(n - cand.n) === 1).length >= 2;
            
            if (
                (tailCount[t] || 0) < CONFIG.constraints.maxSameTail &&
                zoneCount[z] < CONFIG.constraints.maxPerZone &&
                !hasTooManyConsecutive
            ) {
                finalSix.push(cand.n);
                tailCount[t] = (tailCount[t] || 0) + 1;
                zoneCount[z]++;
            }
        }

        // è‹¥ç¯©é¸å¾Œä¸è¶³ 6 ç¢¼ï¼Œå‰‡ç”¨æœ€é«˜åˆ†è£œé½Š
        if (finalSix.length < 6) {
            candidates.forEach(c => {
                if (finalSix.length < 6 && !finalSix.includes(c.n)) finalSix.push(c.n);
            });
        }

        return finalSix.sort((a, b) => a - b);
    }

    document.getElementById('csvFile').addEventListener('change', e => {
        const reader = new FileReader();
        reader.onload = () => {
            const lines = reader.result.replace(/\r/g, "").trim().split('\n');
            rawData = lines.map(l => {
                const c = l.split(',');
                return { 
                    date: c[0].trim(), 
                    nums: c.slice(1, 6).map(x => parseInt(x.trim())).filter(x => !isNaN(x)).sort((a,b)=>a-b) 
                };
            }).filter(r => r.nums.length === 5);
            
            document.getElementById('logBox').innerHTML = "";
            runAnalysis();
        };
        reader.readAsText(e.target.files[0]);
    });

    function runAnalysis() {
        let btHtml = "";
        let hitsArr = [];
        const testCount = 10;
        const testData = rawData.slice(-testCount);

        // 2ï¸âƒ£ & 3ï¸âƒ£ åš´æ ¼é€æœŸå›æ¸¬
        testData.reverse().forEach(row => {
            const targetIdx = rawData.findIndex(r => r.date === row.date);
            const histSlice = rawData.slice(0, targetIdx); // ç¬¬ N æœŸåªçœ‹ 1 ~ N-1
            
            const pred = getV423Prediction(histSlice);
            const hits = row.nums.filter(n => pred.includes(n));
            hitsArr.push(hits.length);
            
            btHtml += `<div class="bt-row">
                <div class="bt-meta"><span>ğŸ“… ${formatDate(row.date)}</span> <span class="star-tag">${hits.length} â˜…</span></div>
                <div class="num-group">
                    <span class="num-label">é–‹ç</span>
                    ${row.nums.map(n => `<div class="n-box ${pred.includes(n)?'hit':''}">${pad(n)}</div>`).join('')}
                </div>
                <div class="num-group">
                    <span class="num-label">é æ¸¬</span>
                    ${pred.map(n => `<div class="n-box" style="color:${row.nums.includes(n)?'var(--primary)':'#888'}; font-weight:${row.nums.includes(n)?'900':'normal'}">${pad(n)}</div>`).join('')}
                </div>
            </div>`;
        });

        document.getElementById('btBody').innerHTML = btHtml;

        // ä¸‹æœŸé æ¸¬
        const next = getV423Prediction(rawData);
        document.getElementById('nextPred').innerHTML = next.map(n => `<div class="ball">${pad(n)}</div>`).join('');
        
        // çŸ©é™£é¡¯ç¤º
        renderMatrix();

        // çµ±è¨ˆè¨ˆç®—
        const avg = hitsArr.reduce((a,b)=>a+b, 0) / testCount;
        const stableCount = hitsArr.filter(h => h >= 2).length;
        
        log(`è³‡æ–™ç¸½é‡: ${rawData.length} æœŸ`);
        log(`æœ€è¿‘ ${testCount} æœŸå¹³å‡å‘½ä¸­: ${avg.toFixed(2)} ç¢¼`);
        log(`â‰¥2 ç¢¼é”æˆç‡: ${(stableCount/testCount*100).toFixed(0)}% (${stableCount}/${testCount} æœŸ)`);
    }

    function renderMatrix() {
        let mHtml = `<table class="m-table"><thead><tr><th class="m-date">æ—¥</th>`;
        for(let i=1; i<=39; i++) mHtml += `<th class="m-head">${pad(i)}</th>`;
        mHtml += `</tr></thead><tbody>`;
        rawData.slice(-15).reverse().forEach(row => {
            mHtml += `<tr><td class="m-date">${formatDate(row.date)}</td>`;
            for(let i=1; i<=39; i++) mHtml += `<td>${row.nums.includes(i) ? '<span class="m-ball"></span>' : ''}</td>`;
            mHtml += `</tr>`;
        });
        document.getElementById('matrixCont').innerHTML = mHtml + `</tbody></table>`;
    }
</script>
</body>
</html>
